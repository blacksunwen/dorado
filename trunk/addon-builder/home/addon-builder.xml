<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant"
         name="wrapper"
         default="buildAll">
	<property environment="env" />

	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${homeDir}/lib/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>
	<taskdef resource="com/bstek/dorado/ant/task.properties">
		<classpath>
			<pathelement path="${homeDir}/lib/dorado-ant-task.jar" />
			<pathelement path="${homeDir}/lib/js.jar" />
			<pathelement path="${homeDir}/lib/commons-lang-2.5.jar" />
		</classpath>
	</taskdef>
	<taskdef name="yui-compressor"
	         classname="net.noha.tools.ant.yuicompressor.tasks.YuiCompressorTask">
		<classpath>
			<pathelement path="${homeDir}/lib/yuicompressor-2.4.2.jar" />
			<pathelement path="${homeDir}/lib/yui-compressor-ant-task-0.5.jar" />
		</classpath>
	</taskdef>
	<taskdef name="jsdoctoolkit"
	         classname="uk.co.darrenhurley.ant.tasks.JsDocToolkit">
		<classpath>
			<pathelement path="${homeDir}/lib/jsdoc-toolkit-ant-task-1.1.2.jar" />
			<pathelement path="${homeDir}/lib/js.jar" />
		</classpath>
	</taskdef>
	<taskdef resource="org/apache/ivy/ant/antlib.xml"
	         uri="antlib:org.apache.ivy.ant">
		<classpath>
			<pathelement location="${homeDir}/lib/ivy-2.2.0.jar" />
			<pathelement location="${homeDir}/lib/oro-2.0.8.jar" />
		</classpath>
	</taskdef>

	<var name="libDir" unset="true" />
	<property name="libDir" value="${homeDir}/lib" />

	<var name="resourcesDir" unset="true" />
	<property name="resourcesDir" value="${homeDir}/resources" />

	<echo message="Base Dir: ${basedir}" />
	<echo message="Work Dir: ${workDir}" />
	<echo message="Home Dir: ${homeDir}" />

	<property name="ivy.fileNamePattern"
	          value="[artifact]-[revision](-[classifier]).[ext]" />

	<property name="jsdoc-toolkit.home"
	          value="${homeDir}/lib/jsdoc_toolkit-2.4.0/" />

	<target name="initVariables">
		<if>
			<not>
				<isset property="addon.revision" />
			</not>
			<then>
				<if>
					<equals arg1="${addon.qualifier}" arg2="RELEASE" />
					<then>
						<property name="addon.revision"
						          value="${addon.version}" />
					</then>
					<else>
						<property name="addon.revision"
						          value="${addon.version}-${addon.qualifier}" />
					</else>
				</if>
			</then>
		</if>

		<if>
			<not>
				<isset property="addon.publication" />
			</not>
			<then>
				<tstamp>
					<format property="addon.publication"
					        pattern="yyMMdd.HHmm"
					        locale="true" />
				</tstamp>
				<property name="addon.fullVersion"
				          value="${addon.revision}.${addon.publication}" />
			</then>
		</if>

		<if>
			<not>
				<isset property="workDir" />
			</not>
			<then>
				<property name="workDir" value="${homeDir}/work" />
			</then>
		</if>
	</target>

	<target name="clean">
		<delete dir="${workDir}" />
	</target>

	<target name="prepareWorkDir">
		<mkdir dir="${workDir}" />
		<mkdir dir="${workDir}/src" />
		<mkdir dir="${workDir}/client" />
		<mkdir dir="${workDir}/bin" />
		<mkdir dir="${workDir}/lib" />
		<mkdir dir="${workDir}/javadoc" />
		<mkdir dir="${workDir}/jsdoc" />
		<mkdir dir="${workDir}/temp" />

		<mkdir dir="${addon.targetDir}" />
	</target>

	<target name="init" depends="initVariables,clean,prepareWorkDir">
		<if>
			<isreference refid="userClasspath" />
			<then>
				<path id="classpath">
					<path refid="userClasspath" />
					<fileset dir="${workDir}/lib" includes="*.jar" />
				</path>
			</then>
			<else>
				<path id="classpath">
					<fileset dir="${workDir}/lib" includes="*.jar" />
				</path>
			</else>
		</if>
	</target>

	<target name="doMergeSource">
		<echo message="Merge Source: ${src} --> ${targetSourceDir}" />
		<if>
			<available file="${src}" />
			<then>
				<copy todir="${targetSourceDir}">
					<fileset dir="${src}" excludes="**/.*/**" />
				</copy>
			</then>
		</if>
	</target>

	<target name="mergeSource">
		<foreach list="${addon.javaSrc}" param="src" target="doMergeSource">
			<param name="targetSourceDir" value="${workDir}/src" />
		</foreach>

		<foreach list="${addon.clientSrc}" param="src" target="doMergeSource">
			<param name="targetSourceDir" value="${workDir}/client" />
		</foreach>
	</target>

	<target name="preprocessClientSource">
		<replace dir="${workDir}/client"
		         token="%version%"
		         value="${product.revision}"
		         encoding="${addon.srcCharset}">
			<include name="**/*.js" />
			<include name="**/*.css" />
		</replace>
	</target>

	<target name="compressCss">
		<if>
			<available file="${workDir}/client/skins" />
			<then>
				<mkdir dir="${workDir}/bin/dorado/skins" />
				<yui-compressor fromDir="${workDir}/client/skins"
				                toDir="${workDir}/bin/dorado/skins"
				                warn="false"
				                munge="true"
				                charset="${addon.srcCharset}"
				                cssSuffix=".min.css"
				                preserveAllSemiColons="false"
				                optimize="true"
				                lineBreakPosition="1000">
					<include name="**/*.css" />
					<exclude name="**/*.min.css" />
				</yui-compressor>
			</then>
		</if>
	</target>

	<target name="jsdoc" if="${addon.buildJsdoc}">
		<copy todir="${workDir}/jsdoc">
			<fileset dir="${resourcesDir}/jsdoc" />
		</copy>

		<jsdoctoolkit jsdochome="${jsdoc-toolkit.home}"
		              suppresssourceout="true"
		              template="json"
		              outputdir="${workDir}/jsdoc/data"
		              verbose="true">
			<fileset dir="${workDir}/client" includes="**/*.js" />
		</jsdoctoolkit>

		<replace dir="${workDir}/jsdoc"
		         token="%addon.name%"
		         value="${addon.name}"
		         encoding="${addon.srcCharset}">
			<include name="index.js" />
		</replace>
		<replace dir="${workDir}/jsdoc"
		         token="%addon.revision%"
		         value="${addon.fullVersion}"
		         encoding="${addon.srcCharset}">
			<include name="index.js" />
		</replace>

		<zip compress="true"
		     destfile="${addon.targetDir}/${addon.archieveName}-${addon.revision}-jsdoc.zip">
			<fileset dir="${workDir}/jsdoc" />
		</zip>
	</target>

	<target name="tidyJavaScript">
		<if>
			<available file="${workDir}/client" />
			<then>
				<js-tidy>
					<fileset dir="${workDir}/client" includes="**/*.js" />
				</js-tidy>
			</then>
		</if>
	</target>

	<target name="compressJavaScript">
		<if>
			<available file="${workDir}/client" />
			<then>
				<mkdir dir="${workDir}/bin/dorado" />

				<yui-compressor fromDir="${workDir}/client"
				                toDir="${workDir}/bin/dorado"
				                warn="false"
				                munge="true"
				                charset="${addon.srcCharset}"
				                jsSuffix=".min.js"
				                preserveAllSemiColons="false"
				                optimize="true"
				                lineBreakPosition="1000">
					<include name="**/*.js" />
					<exclude name="**/*.min.js" />
				</yui-compressor>
			</then>
		</if>
	</target>

	<target name="buildI18N">
		<mkdir dir="${workDir}/bin/dorado/resources/i18n" />
		<build-i18n-resource inputDir="${workDir}/client/resources/i18n"
		                     outputDir="${workDir}/bin/dorado/resources/i18n" />
	</target>

	<target name="buildClient"
	        depends="preprocessClientSource,compressCss,tidyJavaScript,compressJavaScript,buildI18N">
		<copy todir="${workDir}/bin/dorado">
			<fileset dir="${workDir}/client" />
		</copy>
	</target>

	<target name="resolveDependencies">
		<copy file="${resourcesDir}/ivysettings.properties"
		      todir="${workDir}/temp" />
		<copy file="${resourcesDir}/ivysettings.xml"
		      tofile="${workDir}/temp/ivysettings.xml" />

		<propertyfile file="${workDir}/temp/ivysettings.properties">
			<entry key="product.revision" value="${addon.revision}" />
			<entry key="product.status" value="${addon.status}" />
			<entry key="product.publication" value="${addon.publication}" />
		</propertyfile>

		<ivy:configure file="${workDir}/temp/ivysettings.xml" />

		<ivy:resolve file="${resourcesDir}/ivy.xml" />
		<ivy:retrieve pattern="${workDir}/lib/${ivy.fileNamePattern}"
		              conf="compile" />

		<ivy:resolve file="${basedir}/ivy.xml" />
		<ivy:retrieve pattern="${workDir}/lib/${ivy.fileNamePattern}"
		              conf="compile" />
	</target>

	<target name="preprocessJavaSource">
		<propertyfile file="${workDir}/src/META-INF/dorado-package.properties">
			<entry key="version" value="${addon.fullVersion}" />
		</propertyfile>
	</target>

	<target name="compile" depends="resolveDependencies,preprocessJavaSource">
		<javac classpathref="classpath"
		       srcdir="${workDir}/src"
		       destdir="${workDir}/bin"
		       debug="true"
		       deprecation="true"
		       nowarn="false"
		       includeantruntime="true"
		       source="${addon.javaCompatSource}"
		       target="${addon.javaCompatTarget}"
		       encoding="${addon.srcCharset}" />
	</target>

	<target name="javadoc" if="${addon.buildJavaDoc}">
		<javadoc access="protected"
		         author="true"
		         encoding="${addon.srcCharset}"
		         docencoding="${addon.srcCharset}"
		         charset="${addon.srcCharset}"
		         destdir="${workDir}/javadoc"
		         doctitle="${addon.name} API Documentation"
		         nodeprecated="false"
		         nodeprecatedlist="false"
		         noindex="false"
		         nonavbar="false"
		         notree="false"
		         source="${addon.javaCompatSource}"
		         splitindex="true"
		         use="true"
		         version="true"
		         useexternalfile="yes">
			<classpath refid="classpath" />
			<fileset dir="${workDir}/src" />
			<doctitle>&lt;h1&gt;${addon.name} API Documentation&lt;/h1&gt;</doctitle>
			<bottom>Copyright © 2001-2011 www.BSTEK.com All Rights Reserved.</bottom>
			<link href="http://www.BSDN.org/projects/dorado7" />
		</javadoc>
		<copy file="${resourcesDir}/stylesheet.css"
		      todir="${workDir}/javadoc"
		      overwrite="true" />

		<jar compress="true"
		     jarfile="${addon.targetDir}/${addon.archieveName}-${addon.revision}-javadoc.jar">
			<fileset dir="${workDir}/javadoc" />
			<manifest>
				<attribute name="Implementation-Title" value="${addon.name}" />
				<attribute name="Implementation-Vendor"
				           value="${addon.vendor}" />
				<attribute name="Implementation-Version"
				           value="${addon.fullVersion}" />
			</manifest>
		</jar>
	</target>

	<target name="makeJar" if="${addon.buildJar}">
		<jar compress="true"
		     jarfile="${addon.targetDir}/${addon.archieveName}-${addon.revision}.jar">
			<fileset dir="${workDir}/bin" />
			<fileset dir="${workDir}/src" excludes="**/*.java" />
			<manifest>
				<attribute name="Implementation-Title" value="${addon.name}" />
				<attribute name="Implementation-Vendor"
				           value="${addon.vendor}" />
				<attribute name="Implementation-Version"
				           value="${addon.fullVersion}" />
			</manifest>
		</jar>
	</target>

	<target name="buildSourceJar" if="${addon.buildSourceJar}">
		<jar compress="true"
		     jarfile="${addon.targetDir}/${addon.archieveName}-${addon.revision}-sources.jar">
			<fileset dir="${workDir}/src" />
			<manifest>
				<attribute name="Implementation-Title"
				           value="${addon.name}-sources" />
				<attribute name="Implementation-Vendor"
				           value="${addon.vendor}" />
				<attribute name="Implementation-Version"
				           value="${addon.fullVersion}" />
			</manifest>
		</jar>
	</target>

	<target name="makePom">
		<copy file="${resourcesDir}/dorado-addon-template.pom"
		      todir="${workDir}/temp" />
		<replace dir="${workDir}/temp"
		         token="%product.revision%"
		         value="${addon.revision}"
		         encoding="${addon.srcCharset}">
			<include name="dorado-addon-template.pom" />
		</replace>

		<ivy:makepom ivyfile="${basedir}/ivy.xml"
		             pomfile="${addon.targetDir}/${addon.archieveName}-${addon.revision}.pom"
		             templateFile="${workDir}/temp/dorado-addon-template.pom"
		             conf="compile">
			<mapping conf="compile" scope="compile" />
		</ivy:makepom>
	</target>

	<target name="buildJava"
	        depends="compile,javadoc,makeJar,buildSourceJar,makePom" />

	<target name="buildArchieves" depends="mergeSource,buildClient,buildJava" />

	<target name="buildAll" depends="init,buildArchieves" />
</project>