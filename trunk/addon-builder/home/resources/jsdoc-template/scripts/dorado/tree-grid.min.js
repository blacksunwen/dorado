(function(){dorado.widget.treegrid={};dorado.widget.treegrid.ItemModel=$extend([dorado.widget.tree.ItemModel,dorado.widget.grid.ItemModel],{constructor:function(){dorado.widget.grid.ItemModel.prototype.constructor.apply(this,arguments);$invokeSuper.call(this,arguments)},refreshSummary:function(){if(!this._summaryColumns||!this.footerEntity.get("$expired")){return}var d=this.footerEntity._data,b=this;this.initSummary(d);for(var c=new dorado.widget.tree.TreeNodeIterator(this._root,{includeInvisibleNodes:true});c.hasNext();){b.accumulate(c.next(),d)}this.finishSummary(d);this.footerEntity.timestamp=dorado.Core.getTimestamp();this.footerEntity.sendMessage(0)}});dorado.widget.treegrid.RowRenderer=$extend(dorado.widget.grid.DefaultRowRenderer,{renderCell:function(d,e,b){var c=b.node=b.data;b.data=(c instanceof dorado.widget.tree.DataNode)?c._data:c;dorado.Renderer.render(d,e,b)}});dorado.widget.treegrid.TreeColumnCellRenderer=$extend([dorado.widget.grid.DefaultCellRenderer,dorado.widget.tree.TreeNodeRenderer],{getLabel:function(c,b){return c.get("label")||this.getText(c.get("data"),b.column)
},doRender:function(f,c){if(!f.firstChild||f.firstChild.className!="d-tree-node"){$fly(f).empty().xCreate({tagName:"DIV",className:"d-tree-node",content:[{tagName:"LABEL",doradoType:"tree-button",className:"button"},{tagName:"LABEL",className:"label",whiteSpace:"no-wrap"}]});var e=f.firstChild.firstChild,b=jQuery(e),d=this;b.mousedown(function(){return false}).click(function(){var h=e.parentNode.parentNode.parentNode.parentNode;var g=$fly(h).data("item");if(g.get("hasChild")){if(g._expanded){g.collapse()}else{if(g._tree._expandingMode=="sync"){g.expand()}else{g.expandAsync()}}b.removeClass("expand-button-hover collapse-button-hover")}return false}).hover(function(){if(b.hasClass("expand-button")){b.addClass("expand-button-hover")}if(b.hasClass("collapse-button")){b.addClass("collapse-button-hover")}},function(){b.removeClass("expand-button-hover collapse-button-hover")})}dorado.widget.tree.TreeNodeRenderer.prototype.doRender(f.firstChild,c.node);this.renderDirtyFlag(f,c)}});dorado.widget.treegrid.TreeColumnCellEditor=$extend(dorado.widget.grid.DefaultCellEditor,{hideCellContent:false,shouldShow:function(){return $invokeSuper.call(this,arguments)&&!this.node._label
},resize:function(){var d=this.getDom(),f=this.getEditorControl();var c=(dorado.Browser.msie&&dorado.Browser.version<"7");if(f){if(c){f.getDom().style.display="none"}}var m=this.cell,j=$fly(m).find(".label");var e=$fly(m).offset(),i=j.offset().left;var b=e.left,n=e.top,k=m.offsetWidth,g=m.offsetHeight;if(this.minWidth&&this.minWidth>k){k=this.minWidth}if(this.minHeight&&this.minHeight>g){g=this.minHeight}$fly(d).css({left:i,top:n}).outerWidth(k-(i-b)).outerHeight(g);if(f){var k=d.clientWidth,g=d.clientHeight;if(c){f.getDom().style.display=""}f.set("width",k);if(!f.ATTRIBUTES.height.independent){f.set("height",g)}f.refresh()}}});dorado.widget.TreeGrid=$extend([dorado.widget.AbstractGrid,dorado.widget.AbstractTree],{$className:"dorado.widget.AbstractTreeGrid",ATTRIBUTES:{treeColumn:{writeBeforeReady:true},currentNode:{skipRefresh:true,getter:function(b){return(this._domMode==2?this._fixedInnerGrid:this._innerGrid).get(b)},setter:function(c,b){(this._domMode==2?this._fixedInnerGrid:this._innerGrid).set(c,b)
}},currentEntity:{setter:function(d,b){var c=b?this._entityMap[b.entityId]:null;this.set("currentNode",c)},getter:function(){return(this._currentNode)?this._currentNode._data:null}},rowRenderer:{defaultValue:$singleton(dorado.widget.treegrid.RowRenderer)},groupProperty:{readOnly:true},showFilterBar:{readOnly:true}},constructor:function(){this._entityMap={};this._root=this.createRootNode();this._root._setTree(this);this._root._expanded=true;this._autoRefreshLock=0;$invokeSuper.call(this,arguments)},createInnerGrid:function(b){return new dorado.widget.treegrid.InnerTreeGrid(this,b)},createItemModel:function(){var b=new dorado.widget.treegrid.ItemModel(this);b.setItems(this._root);return b},onCellValueEdit:function(b,c){var d=this._entityMap[b.entityId];if(d){this.refreshEntity(d);this.onEntityChanged(d,c._property);this.refreshSummary()}$invokeSuper.call(this,arguments)},createRootNode:function(){return new dorado.widget.tree.DataNode({data:{}})},refreshDom:function(d){if(this._treeColumn){var c=this.findColumns(this._treeColumn),b=c[0];
if(!b){throw new dorado.Exception("TreeColumn ["+this._treeColumn+"] not found.")}if(!(b instanceof dorado.widget.grid.DataColumn)){throw new dorado.Exception("The [treeColumn] is not a DataColumn.")}if(!b._renderer){b._renderer=new dorado.widget.treegrid.TreeColumnCellRenderer()}if(!b._editor){b._editor=new dorado.widget.treegrid.TreeColumnCellEditor()}}$invokeSuper.call(this,arguments)},refreshEntity:function(c){var e=c._id,d,b;if(this._domMode==2){b=this._fixedInnerGrid;d=b._itemDomMap[e];if(d){b.refreshItemDomData(d,c)}}b=this._innerGrid;d=b._itemDomMap[e];if(d){b.refreshItemDomData(d,c)}},getCellEditor:function(d,b){var c=$invokeSuper.call(this,arguments);if(c){c.node=b;c.data=b._data}return c},sort:dorado._UNSUPPORTED_FUNCTION(),filter:dorado._UNSUPPORTED_FUNCTION(),refreshNode:function(b){if(this._autoRefreshLock>0){return}this.refreshEntity(b)},onNodeAttached:function(b){$invokeSuper.call(this,arguments);if(b._data){this._entityMap[b._data.entityId]=b}if(this._rendered){this.refreshSummary()
}},onNodeDetached:function(b){$invokeSuper.call(this,arguments);if(b._data){delete this._entityMap[b._data.entityId]}if(this._rendered){this.refreshSummary()}},findItemDomByEvent:function(b){var c=this._innerGrid.findItemDomByEvent(b);if(!c&&this._fixedInnerGrid){c=this._fixedInnerGrid.findItemDomByEvent(b)}return c},_nodeInserted:function(e){var b=this,d=false;var f=function(i,h){if(d){return}d=true;e._expanding=false;if(i!==false){if(!b._rendered||!b._attached||b._autoRefreshLock>0){return}if(b._currentScrollMode!="viewport"){if(b._domMode==2){b._fixedInnerGrid._nodeInserted(e)}b._innerGrid._nodeInserted(e);b.updateScroller(b._innerGrid._container);b.notifySizeChange()}else{b._refreshAndScroll(e,"insert",e._parent)}}};if(e._expanded){if(this.getListenerCount("beforeExpand")){e._expanding=true;var c=(this._expandingMode=="async");var g={async:c,node:e,callDefault:c?f:undefined,processDefault:true};this.fireEvent("beforeExpand",this,g);if(!g.processDefault){f();e._expanding=false}}else{f()
}}},_nodeRemoved:function(d,b,c){if(!this._rendered||!this._attached||this._autoRefreshLock>0){return}if(this._currentScrollMode!="viewport"){if(this._domMode==2){this._fixedInnerGrid._nodeRemoved(d,b,c)}this._innerGrid._nodeRemoved(d,b,c);this.updateScroller(this._innerGrid._container);self.notifySizeChange()}else{this._refreshAndScroll(d,"remove",b,c)}},_nodeExpanded:function(c){if(!this._rendered||!this._attached||this._autoRefreshLock>0){return}if(this._currentScrollMode!="viewport"){if(this._domMode==2){this._fixedInnerGrid._nodeExpanded(c)}var b=this;this._innerGrid._nodeExpanded(c,function(){b.updateScroller(b._innerGrid._container);b.notifySizeChange()});this.updateScroller(this._innerGrid._container)}else{this._refreshAndScroll(c,"expand",c._parent)}},_nodeCollapsed:function(c){if(!this._rendered||!this._attached||this._autoRefreshLock>0){return}if(this._currentScrollMode!="viewport"){if(this._domMode==2){this._fixedInnerGrid._nodeCollapsed(c)}var b=this;this._innerGrid._nodeCollapsed(c,function(){b.updateScroller(b._innerGrid._container);
b.notifySizeChange()});this.updateScroller(this._innerGrid._container)}else{this._refreshAndScroll(c,"collapse",c._parent)}},_refreshAndScroll:function(c,h,g,d){var m=this._itemModel;if(g._expanded){var o=this._innerGrid._itemDomMap[c._id];if(!o){var k;if(h=="remove"){k=m.getItemIndex(g)+1;var f=g._nodes.iterator();var e=0;while(f.hasNext()&&e<d){var b=f.next();k++,e++;if(b._expanded){k+=b._visibleChildNodeCount}}}else{k=m.getItemIndex(c)}if(k>=0){var l=m.getStartIndex();switch(h){case"insert":if(k<l){m.setStartIndex(l+c._visibleChildNodeCount+1)}break;case"remove":if((k+c._visibleChildNodeCount+1)<l){m.setStartIndex(l-c._visibleChildNodeCount-1)}else{if(k<l){m.setStartIndex(k)}}break;case"expand":if(k<l){m.setStartIndex(l+c._visibleChildNodeCount)}break;case"collapse":if((k+c._visibleChildNodeCount)<l){m.setStartIndex(l-c._visibleChildNodeCount)}else{if(k<l){m.setStartIndex(k+1)}}break}}}this.refreshDom(this._dom)}else{var j=false;switch(h){case"insert":j=g._nodes.size==1;break;case"remove":j=!g.get("hasChild");
break}if(j){this._ignoreItemTimestamp=true;this.refreshEntity(c._parent)}}},_doOnKeyDown:function(l){var f=true,h;var k=this._itemModel.getItems(),b=this.get("currentNode");switch(l.keyCode){case 36:if(l.ctrlKey){this.set("currentNode",this._itemModel.iterator(0).next());h=true}else{this.setCurrentColumn(this._columnsInfo.dataColumns[0])}break;case 35:if(l.ctrlKey){var g=this._itemModel.iterator(0);g.last();this.set("currentNode",g.previous());h=true}else{var d=this._columnsInfo.dataColumns;this.setCurrentColumn(d[d.length-1])}break;case 38:if(b){var j=this._itemModel.getItemIndex(b);if(j>0){var c=this._itemModel.iterator(j-1).next();if(c){this.set("currentNode",c);h=true}}f=false}break;case 40:if(b){var j=this._itemModel.getItemIndex(b);if(j<this._itemModel.getItemCount()-1){var c=this._itemModel.iterator(j+1).next();if(c){this.set("currentNode",c);h=true}}f=false}break;case 13:if(b){f=false;var d=this._columnsInfo.dataColumns,e;if(this._currentColumn){e=d.indexOf(this._currentColumn)||0;
if(l.shiftKey){if(e>0){e--}else{var j=this._itemModel.getItemIndex(b);if(j>0){var c=this._itemModel.iterator(j-1).next();if(c){this.set("currentNode",c);h=true;e=d.length-1}}else{f=true}}}else{if(e<d.length-1){e++}else{var j=this._itemModel.getItemIndex(b);if(j<this._itemModel.getItemCount()-1){var c=this._itemModel.iterator(j+1).next();if(c){this.set("currentNode",c);h=true;e=0}}else{f=true}}}}else{e=l.shiftKey?(d.length-1):0}this.setCurrentColumn(d[e])}break}if(h&&this._selectionMode=="multiRows"){this.set("selection",null)}return f},getHeaderOptionMenu:function(c){function d(f){jQuery.each(f,function(g,h){e.findItem(h).set("visible",false)})}var b=!!this._headerOptionMenu;var e=$invokeSuper.call(this,arguments);if(!b&&e){d(["sortAsc","sortDesc","sortSeprator","group","ungroup","groupSeprator","toggleFilterBar","filterSeprator"])}return e},doOnDraggingSourceMove:dorado.widget.AbstractTree.prototype.doOnDraggingSourceMove,processItemDrop:dorado.widget.AbstractTree.prototype.processItemDrop});
var a=dorado.widget.Tree.prototype;dorado.widget.treegrid.InnerTreeGrid=$extend(dorado.widget.grid.AbstractInnerGrid,{ATTRIBUTES:{currentNode:{skipRefresh:true,setter:function(c,b){if(this._currentNode==b){return}this._currentNode=b;if(this._selectionMode=="singleRow"){this.replaceSelection(null,b)}if(this._rendered&&this._itemDomMap){var d=b?this._itemDomMap[b._id]:null;this.setCurrentRow(d);if(d){this.scrollCurrentIntoView()}}this.fireEvent("onCurrentChange",this);this.grid.doInnerGridSetCurrentRow(this,b?b._id:null)}}},getCurrentItem:function(){return this._currentNode},getCurrentItemId:function(){return this._currentNode?this._currentNode._id:null},setCurrentItemDom:function(b){this.set("currentNode",b?$fly(b).data("item"):null);return true},setCurrentRowByItemId:function(c){var b=this._itemModel.getItemById(c);if(this._currentNode!=b){this.set("currentNode",b)}},createExpandingIndicator:function(){var b=this._expandingIndicator;if(b==null){this._expandingIndicator=b=$DomUtils.xCreateElement({tagName:"TR",className:"d-tree-expanding-placeholder",content:"^TD"})
}b.firstChild.colSpan=this._cols;return b},_getExpandingAnimated:function(){return this.grid._expandingAnimated},refreshItemDoms:a.refreshItemDoms,_nodeInserted:a._nodeInserted,_nodeRemoved:a._nodeRemoved,_insertChildNodes:a._insertChildNodes,_removeChildNodes:a._removeChildNodes,_nodeExpanded:a._nodeExpanded,_nodeCollapsed:a._nodeCollapsed})})();dorado.widget.DataTreeGrid=$extend([dorado.widget.TreeGrid,dorado.widget.DataTree],{$className:"dorado.widget.DataTreeGrid",ATTRIBUTES:{autoCreateColumns:{defaultValue:true}},createRootNode:function(){return new dorado.widget.tree.DataBindingNode({bindingConfig:{}})},onCellValueEdited:null,initColumns:dorado.widget.DataGrid.prototype.initColumns,refresh:function(){var c=false;if(this._dataSet){var a,d=this.getBindingData({firstResultOnly:true,acceptAggregation:true});if(d&&d.dataType){a=d.dataType.getElementDataType("auto")}if(!a){a=this.getBindingDataType("auto")}if(a){this.initColumns(a);c=true}else{if(this._autoCreateColumns&&!this._listeningDataTypeRepository){this._columnInited=false;
this._listeningDataTypeRepository=true;var b=this;this.get("dataTypeRepository").addListener("onDataTypeRegister",function(g,e){var f=b.getBindingDataType("never");if(f){g.removeListener("onDataTypeRegister",arguments.callee);b._autoCreateColumns=true;b._listeningDataTypeRepository=false;b.initColumns(f);b.refresh(true)}})}}if(!this._root._childrenPrepared||this._data!=d){this._root._prepareChildren(dorado._NULL_FUNCTION)}}if(!c){this.initColumns()}$invokeSuper.call(this,arguments)},processItemDrop:dorado.widget.DataTree.prototype.processItemDrop});