<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant"
         xmlns:artifact="antlib:org.apache.maven.artifact.ant"
         default="build">
	<property environment="env" />
	<property file="build.properties" />

	<property name="vendor" value="www.BSTEK.com" />
	<property name="version" value="1.1.2" />
	<property name="qualifier" value="RELEASE" />

	<taskdef resource="net/sf/antcontrib/antlib.xml"
	         classpath="lib/ant-contrib-1.0b3.jar" />
	<taskdef resource="org/apache/ivy/ant/antlib.xml"
	         uri="antlib:org.apache.ivy.ant"
	         classpath="lib/ivy-2.2.0.jar" />
	<typedef resource="org/apache/maven/artifact/ant/antlib.xml"
	         uri="antlib:org.apache.maven.artifact.ant"
	         classpath="lib/maven-ant-tasks-2.1.3.jar" />

	<tstamp>
		<format property="publication" pattern="yyMMdd.HHmm" locale="true" />
	</tstamp>
	<property name="fullVersion" value="${version}.${publication}" />

	<property name="projectDir" value="${workspaceDir}/addon-builder" />
	<property name="workDir" value="${rootWorkDir}/addon-builder" />
	<property name="targetDir" value="lib" />
	<property name="buildAntTasks" value="true" />

	<target name="init">
		<delete dir="${workDir}" />

		<mkdir dir="${workDir}" />
		<mkdir dir="${workDir}/lib" />
		<mkdir dir="${workDir}/src" />
		<mkdir dir="${workDir}/bin" />
	</target>

	<target name="buildAntTasks" if="${buildAntTasks}">
		<ant antfile="build-ant-tasks.xml"
		     inheritAll="false"
		     useNativeBasedir="true" />
	</target>

	<target name="resolveDependencies">
		<ivy:configure file="${workspaceDir}/ivy/ivysettings.xml" />
		<ivy:resolve file="${projectDir}/ivy.xml" />
		<ivy:retrieve pattern="${workDir}/lib/${ivy.fileNamePattern}"
		              conf="compile" />
	</target>

	<target name="compile" depends="resolveDependencies">
		<copy todir="${workDir}/src">
			<fileset dir="${projectDir}/commons" />
			<fileset dir="${projectDir}/builder" />
		</copy>

		<replace dir="${workDir}/src"
		         token="%version%"
		         value="${version}"
		         encoding="utf-8">
			<include name="**/*.java" />
		</replace>
		<replace dir="${workDir}/src"
		         token="%fullVersion%"
		         value="${fullVersion}"
		         encoding="utf-8">
			<include name="**/*.java" />
		</replace>

		<javac srcdir="${workDir}/src"
		       destdir="${workDir}/bin"
		       debug="true"
		       deprecation="true"
		       nowarn="false"
		       includeantruntime="true"
		       target="1.5"
		       encoding="utf-8">
			<classpath>
				<fileset dir="${workDir}/lib" includes="*.jar" />
			</classpath>
		</javac>
	</target>

	<target name="jar">
		<mkdir dir="${workDir}/bin/resources" />
		<zip compress="true" destfile="${workDir}/bin/resources/home.zip">
			<fileset dir="${projectDir}/home" />
		</zip>

		<jar compress="true"
		     jarfile="${targetDir}/dorado-addon-builder-${version}.jar">
			<fileset dir="${workDir}/bin" />
			<fileset dir="${workDir}/src" excludes="**/*.java" />
			<manifest>
				<attribute name="Implementation-Title" value="${name}" />
				<attribute name="Implementation-Vendor" value="${vendor}" />
				<attribute name="Implementation-Version"
				           value="${fullVersion}" />
			</manifest>
		</jar>

		<copy file="${targetDir}/dorado-addon-builder-${version}.jar"
		      tofile="lib/dorado-addon-builder.jar"
		      overwrite="true" />
	</target>

	<target name="makePom">
		<copy file="${projectDir}/dorado-addon-builder.pom"
		      todir="${workDir}" />
		<replace dir="${workDir}"
		         token="%version%"
		         value="${version}"
		         encoding="utf-8">
			<include name="dorado-addon-builder.pom" />
		</replace>
	</target>

	<target name="build" depends="init,buildAntTasks,compile,jar,makePom" />

	<target name="publish" depends="init,buildAntTasks,compile,jar,makePom">
		<artifact:deploy file="${targetDir}/dorado-addon-builder-${version}.jar"
		                 settingsfile="resources/maven-settings.xml">
			<remoteRepository url="${bsdn.nexusReleases}">
				<authentication username="${env.BSDN_NEXUS_USER}"
				                password="${env.BSDN_NEXUS_PASSWORD}" />
			</remoteRepository>
			<pom file="${workDir}/dorado-addon-builder.pom" />
		</artifact:deploy>
	</target>
</project>