<?xml version="1.0" encoding="UTF-8"?>
<project name="build-client" default="build">
	<property name="jsdoc.dist" value="${workspace}/jsdoc/src" />
	<property name="jsdoc-toolkit.home" value="${lib.dir}/jsdoc_toolkit-2.4.0/jsdoc-toolkit/" />

	<taskdef name="yui-compressor" classname="net.noha.tools.ant.yuicompressor.tasks.YuiCompressorTask">
		<classpath>
			<pathelement path="${lib.dir}/yuicompressor-2.4.2.jar" />
			<pathelement path="${lib.dir}/yui-compressor-ant-task-0.5.jar" />
		</classpath>
	</taskdef>
	<taskdef name="jsdoctoolkit" classname="uk.co.darrenhurley.ant.tasks.JsDocToolkit">
		<classpath>
			<pathelement path="${lib.dir}/jsdoctoolkit-ant-task-1.0.2.jar" />
			<pathelement path="${lib.dir}/js.jar" />
		</classpath>
	</taskdef>
	<taskdef name="js-tidy" classname="com.bstek.dorado.ant.JsTidyTask">
		<classpath>
			<pathelement path="${lib.dir}/dorado-ant-task.jar" />
			<pathelement path="${lib.dir}/js.jar" />
		</classpath>
	</taskdef>
	<taskdef name="build-i18n-resource" classname="com.bstek.dorado.ant.BuildI18NResourceTask">
		<classpath>
			<pathelement path="${lib.dir}/dorado-ant-task.jar" />
			<pathelement path="${lib.dir}/commons-lang-2.5.jar" />
		</classpath>
	</taskdef>

	<target name="copy-project-source">
		<echo message="copy-project-source: ${module.project}" />
		<property name="project.root" value="${workspace.dir}/${module.project}" />

		<if>
			<available file="${project.root}/client" />
			<then>
				<if>
					<available file="${project.root}/client/build-client.xml" />
					<then>
						<echo message="custom build file: ${project.root}/client/build-client.xml" />
						<ant antfile="${project.root}/client/build-client.xml" inheritRefs="true">
							<property name="src" value="${project.root}/client" />
						</ant>
					</then>
					<else>
						<copy todir="${dist}/scripts">
							<fileset dir="${project.root}/client/scripts" />
						</copy>
						<copy todir="${dist}/skins">
							<fileset dir="${project.root}/client/skins" />
						</copy>
						<copy todir="${dist}/resources">
							<fileset dir="${project.root}/client/resources" />
						</copy>
					</else>
				</if>
			</then>
		</if>
	</target>

	<target name="copy-source">
		<foreach list="${module.projects}" param="module.project" target="copy-project-source" inheritall="true" />
	</target>

	<target name="compressor-css" unless="dont-compressor-css">
		<if>
			<available file="${dist}/skins" />
			<then>
				<yui-compressor fromDir="${dist}/skins" toDir="${dist}/skins" warn="false" munge="true" charset="utf-8" cssSuffix=".min.css" preserveAllSemiColons="false" optimize="true" lineBreakPosition="1000">
					<include name="**/*.css" />
					<exclude name="**/*.min.css" />
				</yui-compressor>
			</then>
		</if>
	</target>

	<target name="tidy-js" unless="dont-tidy-js">
		<js-tidy>
			<fileset dir="${dist}">
				<include name="**/*.js" />
			</fileset>
		</js-tidy>
	</target>

	<target name="compressor-js" unless="dont-compressor-js">
		<if>
			<available file="${dist}" />
			<then>
				<yui-compressor fromDir="${dist}" toDir="${dist}" warn="false" munge="true" charset="utf-8" jsSuffix=".min.js" preserveAllSemiColons="false" optimize="true" lineBreakPosition="1000">
					<include name="**/*.js" />
					<exclude name="**/*.min.js" />
				</yui-compressor>
			</then>
		</if>
	</target>

	<target name="build-i18n" if="build-i18n">
		<echo message="build-i18n: ${dist}/resources/i18n" />
		<build-i18n-resource inputDir="${dist}/resources/i18n" outputDir="${dist}/resources/i18n" />
	</target>
	
	<target name="build" depends="copy-source,compressor-css,tidy-js,compressor-js,build-i18n" />
</project>
