<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant" default="build">
	<property name="izpack.dir" value="D:/projects/dorado7/build/IzPack4" />
	<property name="release.dir" value="D:/projects/dorado7/dist" />

	<taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant">
		<classpath>
			<pathelement location="${lib.dir}/${ivy.jar}" />
			<pathelement location="${lib.dir}/${oro.jar}" />
		</classpath>
	</taskdef>
	<taskdef name="IzPack" classname="com.izforge.izpack.ant.IzPackTask">
		<classpath>
			<pathelement path="${izpack.dir}/lib/compiler.jar" />
			<pathelement path="${izpack.dir}/lib/org.eclipse.equinox.p2.jarprocessor_1.0.200.v20100503a.jar" />
		</classpath>
	</taskdef>

	<!--
	<taskdef name="IzPack"
	         classpath="${izpack.dir}/lib/izpack-ant-5.0.0-beta6.jar"
	         classname="com.izforge.izpack.ant.IzPackTask">
		<classpath>
			<fileset dir="${izpack.dir}/lib/">
				<include name="*.jar" />
			</fileset>
		</classpath>
	</taskdef>
	-->

	<target name="init">
		<mkdir dir="${work.dir}/installer" />
	</target>

	<target name="retrieve-jars">
		<delete>
			<fileset dir="${standard-edition.dir}/lib/dorado" includes="Ã—.jar" />
		</delete>
		<copy todir="${standard-edition.dir}/lib/dorado">
			<fileset dir="${target.lib.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>

		<delete>
			<fileset dir="${standard-edition.dir}/lib/endorsed" includes="*.jar" />
		</delete>
		<ivy:configure file="${work.dir}/ivysettings.xml" />
		<ivy:resolve file="${resources.dir}/blank-project/ivy.xml" />
		<ivy:retrieve pattern="${standard-edition.dir}/lib/endorsed/[artifact]-[revision](-[classifier]).[ext]" conf="runtime" />
	</target>

	<target name="retrieve-sources">
		<delete>
			<fileset dir="${standard-edition.dir}/src" includes="*.jar" />
		</delete>
		<copy todir="${standard-edition.dir}/src">
			<fileset dir="${target.src.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>

	<target name="do-update-blank-project">
		<property name="temp.dir" value="${work.dir}/installer/com.bstek.ide.template2" />
		<unzip src="${file}" dest="${temp.dir}" overwrite="true" />

		<delete dir="${temp.dir}/standard" />
		<mkdir dir="${temp.dir}/standard" />
		<copy todir="${temp.dir}/standard">
			<fileset dir="${work.dir}/blank" />
		</copy>

		<delete dir="${file}" />
		<zip destfile="${file}" compress="true" level="9">
			<fileset dir="${temp.dir}" />
		</zip>
	</target>

	<target name="update-blank-project">
		<foreach target="do-update-blank-project" param="file" inheritall="true">
			<path>
				<fileset dir="${standard-edition.dir}/eclipse/dropins/dorado7/plugins">
					<include name="com.bstek.ide.template2_*.jar" />
				</fileset>
			</path>
		</foreach>
	</target>

	<target name="do-update-sample-center">
		<property name="temp.dir" value="${work.dir}/installer/com.bstek.ide.sample" />
		<unzip src="${file}" dest="${temp.dir}" overwrite="true" />

		<delete dir="${temp.dir}/samples" />
		<mkdir dir="${temp.dir}/samples" />
		<copy todir="${temp.dir}/samples" file="${work.dir}/sample-center/sample-center.zip" />

		<delete dir="${file}" />
		<zip destfile="${file}" compress="true" level="9">
			<fileset dir="${temp.dir}" />
		</zip>
	</target>

	<target name="update-sample-center">
		<foreach target="do-update-sample-center" param="file" inheritall="true">
			<path>
				<fileset dir="${standard-edition.dir}/eclipse/dropins/dorado7/plugins">
					<include name="com.bstek.ide.sample_*.jar" />
				</fileset>
			</path>
		</foreach>
	</target>

	<target name="do-update-hibernate">
		<property name="temp.dir" value="${work.dir}/installer/com.bstek.ide.hibernate" />
		<unzip src="${file}" dest="${temp.dir}" overwrite="true" />

		<delete dir="${temp.dir}/web/WEB-INF/lib" />
		<mkdir dir="${temp.dir}/web/WEB-INF/lib" />
		<copy todir="${temp.dir}/web/WEB-INF/lib">
			<fileset dir="${target.lib.dir}" includes="dorado-hibernate-*.jar" />
			<fileset dir="${work.dir}/sample-center/web/WEB-INF/lib" includes="hibernate-*.jar" />
		</copy>

		<delete dir="${file}" />
		<zip destfile="${file}" compress="true" level="9">
			<fileset dir="${temp.dir}" />
		</zip>
	</target>

	<target name="update-hibernate">
		<foreach target="do-update-hibernate" param="file" inheritall="true">
			<path>
				<fileset dir="${standard-edition.dir}/eclipse/dropins/dorado7/plugins">
					<include name="com.bstek.ide.hibernate_*.jar" />
				</fileset>
			</path>
		</foreach>
	</target>

	<target name="do-update-desktop">
		<property name="temp.dir" value="${work.dir}/installer/com.bstek.ide.desktop" />
		<unzip src="${file}" dest="${temp.dir}" overwrite="true" />

		<delete dir="${temp.dir}/web/WEB-INF/lib" />
		<mkdir dir="${temp.dir}/web/WEB-INF/lib" />
		<copy todir="${temp.dir}/web/WEB-INF/lib">
			<fileset dir="${target.lib.dir}" includes="dorado-desktop-*.jar" />
		</copy>

		<delete dir="${file}" />
		<zip destfile="${file}" compress="true" level="9">
			<fileset dir="${temp.dir}" />
		</zip>
	</target>

	<target name="update-desktop">
		<foreach target="do-update-desktop" param="file" inheritall="true">
			<path>
				<fileset dir="${standard-edition.dir}/eclipse/dropins/dorado7/plugins">
					<include name="com.bstek.ide.desktop_*.jar" />
				</fileset>
			</path>
		</foreach>
	</target>

	<target name="do-update-chart">
		<property name="temp.dir" value="${work.dir}/installer/com.bstek.ide.chart" />
		<unzip src="${file}" dest="${temp.dir}" overwrite="true" />

		<delete dir="${temp.dir}/web/WEB-INF/lib" />
		<mkdir dir="${temp.dir}/web/WEB-INF/lib" />
		<copy todir="${temp.dir}/web/WEB-INF/lib">
			<fileset dir="${target.lib.dir}" includes="dorado-chart-*.jar" />
		</copy>

		<delete dir="${file}" />
		<zip destfile="${file}" compress="true" level="9">
			<fileset dir="${temp.dir}" />
		</zip>
	</target>

	<target name="update-chart">
		<foreach target="do-update-chart" param="file" inheritall="true">
			<path>
				<fileset dir="${standard-edition.dir}/eclipse/dropins/dorado7/plugins">
					<include name="com.bstek.ide.chart_*.jar" />
				</fileset>
			</path>
		</foreach>
	</target>

	<target name="do-update-helloworld">
		<property name="temp.dir" value="${work.dir}/installer/com.bstek.ide.helloworld" />
		<unzip src="${file}" dest="${temp.dir}" overwrite="true" />

		<copy todir="${temp.dir}">
			<fileset dir="${resources.dir}/hello-world" includes="**/*.*" />
		</copy>

		<delete dir="${file}" />
		<zip destfile="${file}" compress="true" level="9">
			<fileset dir="${temp.dir}" />
		</zip>
	</target>

	<target name="update-helloworld">
		<foreach target="do-update-helloworld" param="file" inheritall="true">
			<path>
				<fileset dir="${standard-edition.dir}/eclipse/dropins/dorado7/plugins">
					<include name="com.bstek.ide.helloworld_*.jar" />
				</fileset>
			</path>
		</foreach>
	</target>

	<target name="update-ide" depends="update-blank-project,update-sample-center,update-hibernate,update-desktop,update-chart,update-helloworld" />

	<target name="build-installer">
		<echo message="Makes the installer using IzPack" />
		<echo message="${basedir}/izpack-install.xml" />
		<echo message="${standard-edition.dir}" />
		<echo message="${izpack.dir}" />

		<!--
		<IzPack input="${basedir}/izpack-install.xml" output="${release.dir}/dorado-${product.version}-installer.jar" installerType="standard" basedir="${standard-edition.dir}" IzPackDir="${izpack.dir}/" />
		-->

		<!--
		<IzPack input="${basedir}/izpack-install.xml"
			output="${release.dir}/dorado.${product.version}.installer.jar"
			installerType="web"
			basedir="${standard-edition.dir}"
			IzPackDir="${izpack.dir}/" />
		-->
	</target>

	<target name="build" depends="init,retrieve-jars,retrieve-sources,update-ide" />
</project>
