<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:artifact="antlib:org.apache.maven.artifact.ant"
         name="build"
         default="buildAndPublish">
	<property environment="env" />
	<property file="build.properties" />

	<property name="version" value="${coreVersion}" />
	<property name="qualifier" value="${coreQualifier}" />

	<taskdef resource="net/sf/antcontrib/antlib.xml"
	         classpath="lib/ant-contrib-1.0b3.jar" />
	<taskdef resource="com/bstek/dorado/addonbuilder/task.properties"
	         classpath="lib/dorado-addon-builder.jar" />
	<typedef resource="org/apache/maven/artifact/ant/antlib.xml"
	         uri="antlib:org.apache.maven.artifact.ant"
	         classpath="lib/maven-ant-tasks-2.1.3.jar" />

	<target name="init">
		<if>
			<equals arg1="${qualifier}" arg2="SNAPSHOT" />
			<then>
				<property name="maven.repository"
				          value="${bsdn.nexusSnapshots}" />
			</then>
			<else>
				<property name="maven.repository"
				          value="${bsdn.nexusReleases}" />
			</else>
		</if>
	</target>

	<target name="build" depends="init">
		<delete dir="${rootWorkDir}/core" />
		<mkdir dir="${rootWorkDir}/core" />

		<buildDoradoAddon baseDir="${workspaceDir}/core"
		                  workDir="${rootWorkDir}/core"
		                  targetDir="${targetDir}"
		                  name="dorado-core"
		                  vendor="${vendor}"
		                  version="${version}"
		                  qualifier="${qualifier}"
		                  buildSourceJar="${buildSourceJar}"
		                  buildJsDoc="${buildJsDoc}"
		                  buildJavaDoc="${buildJavaDoc}"
		                  clientSrc="${workspaceDir}/client/client"
		                  javaSrc="${workspaceDir}/core/src,${workspaceDir}/web/src,${workspaceDir}/data/src,${workspaceDir}/view/src,${workspaceDir}/ide-support/src" />
		<echo message="Build Dorado Addon Succeed: ${baseFileName}" />
		<property name="coreBaseFileName" value="${baseFileName}" />
	</target>

	<target name="publish" depends="build">
		<var name="fileName" value="${coreBaseFileName}" />
		<echo message="Publish to bsdn: ${targetDir}/${fileName}.jar --> ${maven.repository}" />

		<artifact:deploy file="${targetDir}/${fileName}.jar"
		                 settingsfile="resources/maven-settings.xml">
			<remoteRepository url="${maven.repository}">
				<authentication username="${env.BSDN_NEXUS_USER}"
				                password="${env.BSDN_NEXUS_PASSWORD}" />
			</remoteRepository>
			<pom file="${targetDir}/${fileName}.pom" />
			<attach file="${targetDir}/${fileName}-sources.jar"
			        type="jar"
			        classifier="sources" />
			<attach file="${targetDir}/${fileName}-javadoc.jar"
			        type="jar"
			        classifier="javadoc" />
			<attach file="${targetDir}/${fileName}-jsdoc.zip"
			        type="zip"
			        classifier="jsdoc" />
		</artifact:deploy>
	</target>

	<target name="buildJars">
		<property name="buildSourceJar" value="false" />
		<property name="buildJsDoc" value="false" />
		<property name="buildJavaDoc" value="false" />

		<antcall target="build" />
	</target>

	<target name="buildLibraries">
		<property name="buildSourceJar" value="false" />
		<property name="buildJsDoc" value="false" />
		<property name="buildJavaDoc" value="false" />

		<antcall target="build" />
	</target>

	<target name="buildAndPublish">
		<property name="buildSourceJar" value="true" />
		<property name="buildJsDoc" value="true" />
		<property name="buildJavaDoc" value="true" />

		<antcall target="publish" />
	</target>
</project>
