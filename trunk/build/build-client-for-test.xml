<?xml version="1.0" encoding="UTF-8"?>
<project name="build" default="build">
	<property file="build.properties" />

	<property name="dist" value="${workspaceDir}/client/bin" />
	<property name="workDir" value="${rootWorkDir}/client" />
	<property name="clientSrc"
	          value="${workspaceDir}/client/client,${workspaceDir}/chart/client,${workspaceDir}/desktop/client,${workspaceDir}/htmleditor/client,${workspaceDir}/tag-editor/client" />

	<taskdef resource="net/sf/antcontrib/antlib.xml"
	         classpath="lib/ant-contrib-1.0b3.jar" />
	<taskdef resource="com/bstek/dorado/addonbuilder/task.properties"
	         classpath="lib/dorado-addon-builder.jar" />

	<target name="init">
		<makeAddonBuilderHome />
		<taskdef resource="com/bstek/dorado/taskdefs/task.properties">
			<classpath>
				<pathelement path="${addonBuilder.homeDir}/lib/dorado-ant-tasks.jar" />
				<pathelement path="${addonBuilder.homeDir}/lib/js.jar" />
				<pathelement path="${addonBuilder.homeDir}/lib/commons-lang-2.5.jar" />
			</classpath>
		</taskdef>
	</target>

	<target name="doMergeClientSource">
		<echo message="Merge Client Source: ${src} --> ${dist}" />
		<if>
			<available file="${src}" />
			<then>
				<if>
					<available file="${src}/build-client.xml" />
					<then>
						<echo message="Custom Client Build File: ${src}/build-client.xml" />
						<ant antfile="${src}/build-client.xml"
						     inheritRefs="false">
							<property name="src" value="${src}" />
							<property name="dist" value="${dist}" />
						</ant>
					</then>
					<else>
						<copy todir="${dist}">
							<fileset dir="${src}" excludes="*.xml" />
						</copy>
					</else>
				</if>

				<concat destfile="${dist}/skins/inherent/all.css"
				        fixlastline="true"
				        encoding="utf-8">
					<filelist dir="${dist}/skins/inherent">
						<file name="common.css" />
						<file name="widget.css" />
						<file name="base-widget.css" />
						<file name="list.css" />
						<file name="grid.css" />
						<file name="tree.css" />
						<file name="block-view.css" />
						<file name="debugger.css" />
						<file name="portal.css" />
					</filelist>
				</concat>

				<concat destfile="${dist}/skins/default/all.css"
				        fixlastline="true"
				        encoding="utf-8">
					<filelist dir="${dist}/skins/default">
						<file name="common.css" />
						<file name="widget.css" />
						<file name="base-widget.css" />
						<file name="list.css" />
						<file name="grid.css" />
						<file name="tree.css" />
						<file name="block-view.css" />
						<file name="debugger.css" />
						<file name="portal.css" />
					</filelist>
				</concat>
			</then>
		</if>
	</target>

	<target name="mergeClientSource" depends="init">
		<foreach list="${clientSrc}" param="src" target="doMergeClientSource" />
	</target>

	<target name="tidyJavaScript" depends="init">
		<tidyJavaScript>
			<fileset dir="${dist}" includes="**/*.js" />
		</tidyJavaScript>
	</target>

	<target name="compress">
		<taskdef name="yui-compressor"
		         classname="net.noha.tools.ant.yuicompressor.tasks.YuiCompressorTask">
			<classpath>
				<pathelement path="${addonBuilder.homeDir}/lib/yuicompressor-2.4.2.jar" />
				<pathelement path="${addonBuilder.homeDir}/lib/yui-compressor-ant-task-0.5.jar" />
			</classpath>
		</taskdef>

		<delete dir="${workDir}" />
		<mkdir dir="${workDir}" />

		<mkdir dir="${workDir}/dorado/skins" />
		<yui-compressor fromDir="${dist}/skins"
		                toDir="${workDir}/dorado/skins"
		                warn="false"
		                munge="true"
		                charset="UTF-8"
		                cssSuffix=".min.css"
		                preserveAllSemiColons="false"
		                optimize="true"
		                lineBreakPosition="1000">
			<include name="**/*.css" />
			<exclude name="**/*.min.css" />
		</yui-compressor>

		<mkdir dir="${workDir}/dorado" />
		<yui-compressor fromDir="${dist}"
		                toDir="${workDir}/dorado"
		                warn="false"
		                munge="true"
		                charset="UTF-8"
		                jsSuffix=".min.js"
		                preserveAllSemiColons="false"
		                optimize="true"
		                lineBreakPosition="1000">
			<include name="**/*.js" />
			<exclude name="**/*.min.js" />
		</yui-compressor>

		<copy todir="${workDir}/dorado">
			<fileset dir="${dist}" />
		</copy>
		<jar jarfile="${workspaceDir}/sample-center/web/WEB-INF/lib/dorado-client-for-test.jar">
			<fileset dir="${workDir}" />
		</jar>
	</target>

	<target name="buildI18N" depends="init">
		<mkdir dir="${dist}/resources/i18n" />
		<buildI18NResource inputDir="${dist}/resources/i18n"
		                   outputDir="${dist}/resources/i18n" />
	</target>

	<target name="build" depends="mergeClientSource,buildI18N" />
</project>
