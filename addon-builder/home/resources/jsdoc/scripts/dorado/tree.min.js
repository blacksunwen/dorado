dorado.widget.tree={};dorado.widget.tree.NodeList=$extend(dorado.util.KeyedArray,{$className:"dorado.widget.tree.NodeList",constructor:function(a,b){$invokeSuper.call(this,[b]);this.parent=a},beforeInsert:function(c){var a=c._parent=this.parent;var b=a.get("hasChild");c._setTree(a._tree);return{parentNode:a,originHasChild:b}},afterInsert:function(e,d){var b=d.parentNode,c=d.originHasChild,a=b._tree;b._changeVisibleChildNodeCount(1+((e._expanded)?e._visibleChildNodeCount:0));if(a&&(b._expanded||!c)&&a._rendered&&a._attached&&a._autoRefreshLock<1){a._nodeInserted(e)}},beforeRemove:function(g){var b=g._tree,a=this.parent,d=this.indexOf(g);if(b&&g==b._currentNode&&a){var c;var f=a._nodes.size;if(f==1){c=a}else{var e=0;if(d<f-1){e=d+1}else{if(d>0){e=d-1}}c=a._nodes.get(e)}b.set("currentNode",c)}g._setTree(null);delete g._parent;return{parentNode:a,index:d}},afterRemove:function(e,c){var b=c.parentNode,d=c.index,a=b._tree;b._changeVisibleChildNodeCount(-1-((e._expanded)?e._visibleChildNodeCount:0));
if(a&&b._expanded&&a._rendered&&a._attached&&a._autoRefreshLock<1){a._nodeRemoved(e,b,d)}}});dorado.widget.tree.Node=$extend([dorado.AttributeSupport,dorado.EventSupport],{$className:"dorado.widget.tree.Node",_visibleChildNodeCount:0,ATTRIBUTES:{tree:{readOnly:true},parent:{readOnly:true},nodes:{setter:function(b,a){this.addNodes(a)}},firstNode:{readOnly:true,getter:function(){return this._expanded?this._nodes.get(0):null}},label:{},icon:{},iconClass:{},expandedIcon:{},expandedIconClass:{},checkable:{},checked:{defaultValue:false,setter:function(d,c){if(this._checked===c){return}var b=this._tree,a={node:this,processDefault:true};b.fireEvent("beforeNodeCheckedChange",b,a);if(!a.processDefault){return}this._checked=c;b.fireEvent("onNodeCheckedChange",b,a);if(this.get("checkable")){this._nodeCheckedChanged(this._checked,true,true)}}},autoCheckChildren:{defaultValue:true},tip:{},data:{},hasChild:{getter:function(){return(this._nodes.size>0)||this._hasChild}},expanded:{},expanding:{readOnly:true},visible:{readOnly:true,getter:function(){if(!this._tree){return false
}var a=this._parent;while(a){if(!a._expanded){return false}a=a._parent}return true}},userData:{},level:{readOnly:true,getter:function(){var b=this,a=-1;while(b){a++;b=b._parent}return a}}},constructor:function(a){this._id=dorado.Core.newId();this._nodes=new dorado.widget.tree.NodeList(this,dorado._GET_ID);$invokeSuper.call(this,arguments);if(a){if(a.constructor==String){this._label=a}else{this.set(a)}}},_setTree:function(a){if(this._tree!=a){if(this._tree!=null&&this._tree.onNodeDetached){this._tree.onNodeDetached(this)}this._tree=a;if(a!=null&&a.onNodeAttached){a.onNodeAttached(this)}this._nodes.each(function(b){b._setTree(a)})}},_changeVisibleChildNodeCount:function(b){if(isNaN(b)){return}this._visibleChildNodeCount+=b;if(this._expanded){this._timestamp=dorado.Core.getTimestamp()}var c=this,a=c._parent;while(a&&c._expanded){a._visibleChildNodeCount+=b;c=a,a=a._parent}},doSet:function(a,c){$invokeSuper.call(this,arguments);var b=this.ATTRIBUTES[a];if(b&&!b.skipRefresh){this._timestamp=dorado.Core.getTimestamp();
this.refresh()}},getTimestamp:function(){return this._timestamp},_nodeCheckedChanged:function(f,c,d,e){var i=this._tree;if(c){if(!i._autoChecking){i._autoCheckingChildren=true}if(i._autoCheckingChildren&&this._autoCheckChildren){i._autoCheckingParent=false;i._autoChecking=true;this._nodes.each(function(j){if(j.get("checkable")){j.set("checked",f)}});i._autoChecking=false}}if(d){var g=this._parent;if(!i._autoChecking){i._autoCheckingParent=true}if(i._autoCheckingParent&&g&&g.get("checkable")&&g._autoCheckChildren){i._autoCheckingChildren=false;var b=0,a=0,h=this;g._nodes.each(function(j){if(j==h&&e){return}if(j.get("checkable")){a++;if(j.get("checked")===true){b++}}});if(a){i._autoChecking=true;g.set("checked",(b==0)?false:((b==a)?true:null));i._autoChecking=false}}}},refresh:function(){var a=this._tree;if(a&&a._rendered&&a._attached&&a._ignoreRefresh<1&&a._autoRefreshLock<1){dorado.Toolkits.setDelayedAction(this,"$refreshDelayTimerId",function(){a.refreshNode(this)},50)}},createChildNode:function(a){return new dorado.widget.tree.Node(a)
},addNode:function(b,c,a){if(b instanceof dorado.widget.tree.Node){this._nodes.insert(b,c,a)}else{b=this.createChildNode(b);this._nodes.insert(b,c,a)}if(b.get("checkable")){b._nodeCheckedChanged(b.get("checked"),false,true)}return b},addNodes:function(a){for(var b=0;b<a.length;b++){this.addNode(a[b])}},remove:function(){if(this._parent){if(this.get("checkable")){this._nodeCheckedChanged(false,false,true,true)}this._parent._nodes.remove(this)}},clearChildren:function(){this._nodes.clear()},_expand:function(a){this._expanded=true;this._expanding=false;this._timestamp=dorado.Core.getTimestamp();if(this._parent){this._parent._changeVisibleChildNodeCount(this._visibleChildNodeCount)}this._tree._nodeExpanded(this,a);this._hasExpanded=true},doExpand:function(a){this._expand(a)},doExpandAsync:function(a){this._expand(a)},expand:function(c){if(this._expanded||!this._tree){$callback(c);return}var a=this._tree;var b={async:false,node:this,processDefault:true};a.fireEvent("beforeExpand",a,b);if(!b.processDefault){return
}if(this.doExpand){this.doExpand(c)}a.fireEvent("onExpand",a,b)},expandAsync:function(f){if(this._expanded||!this._tree){$callback(f);return}var a=this._tree,b=this,c=false;var d=function(h,g){if(c){return}c=true;b._expanding=false;if(h===false){$callback(f,h,g)}else{b.doExpandAsync({callback:function(j,i){$callback(f,j,i);delete e.callback;a.fireEvent("onExpand",a,e)}})}};this._expanding=true;this._timestamp=dorado.Core.getTimestamp();a.refreshNode(this);var e={async:true,node:this,callDefault:d,processDefault:true};if(a.getListenerCount("beforeExpand")){a.fireEvent("beforeExpand",a,e);if(!e.processDefault){this._expanding=false;this._timestamp=dorado.Core.getTimestamp();a.refreshNode(this)}}else{d()}},doCollapse:function(){this._expanded=false;this._timestamp=dorado.Core.getTimestamp();if(this._parent){this._parent._changeVisibleChildNodeCount(-this._visibleChildNodeCount)}var a=this;this._tree._nodeCollapsed(this)},collapse:function(){if(!this._expanded){return}var a=this._tree;var b={node:this,processDefault:true};
if(a){a.fireEvent("beforeCollapse",a,b)}if(!b.processDefault){return}this.doCollapse();if(a){a.fireEvent("onCollapse",a,b)}},highlight:function(a,b){if(this._tree){this._tree.highlightItem(this,a,b)}}});dorado.widget.tree.DataNode=$extend(dorado.widget.tree.Node,{$className:"dorado.widget.tree.DataNode",ATTRIBUTES:{data:{setter:function(b,a){if(!(a instanceof dorado.Entity)){a=new dorado.Entity(a)}this._data=a}}},createChildNode:function(a){return new dorado.widget.tree.DataNode(a)},getTimestamp:function(){return((this._data)?this._data.timestamp:0)+this._timestamp},_getEntityProperty:function(a,b){if(!a||!b){return null}return(a instanceof dorado.Entity)?a.get(b):a[b]}});dorado.widget.tree.TreeNodeIterator=$extend(dorado.util.Iterator,{$className:"dorado.widget.tree.TreeNodeIterator",constructor:function(h,i){var e=(i&&i.nextIndex>0)?i.nextIndex:0;var g=this.includeInvisibleNodes=i?!!i.includeInvisibleNodes:false;this._iterators=[h._nodes.iterator()];if(e>0){var c=0,d=this._iterators.peek();
while(c<e){var b=d.next(),f=false;if(b){var a=c+((b._expanded||g)?(1+b._visibleChildNodeCount):1);if(a<e){c=a}else{if(a==e){while((b._expanded||g)&&b._nodes.size>0){d=b._nodes.iterator();d.last();this._iterators.push(d);b=b._nodes.get(b._nodes.size-1)}break}else{f=true;c++}}}else{f=true}if(f){var b=d.current();if(!b||(!b._expanded&&!g)||b._nodes.size==0){break}d=b._nodes.iterator();this._iterators.push(d)}}}},_findLastSubNode:function(c){var a=this._iterators;while((c._expanded||this.includeInvisibleNodes)&&c._nodes.size>0){var b=c._nodes.iterator();b.last();a.push(b);c=b.previous()}return c},first:function(){var a=this._iterators;a.splice(1,a.length-1);a[0].first()},last:function(){var a=this._iterators;a.splice(1,a.length-1);a[0].last();var b=a[0].previous();if(b){this._findLastSubNode(b);a.peek().last()}},hasPrevious:function(){return(this._iterators.length>1||this._iterators[0].hasPrevious())},hasNext:function(){var b=this._iterators;var c=b.peek().current();if(c&&c._nodes.size>0&&(c._expanded||this.includeInvisibleNodes)){return true
}for(var a=b.length-1;a>=0;a--){if(b[a].hasNext()){return true}}return false},previous:function(){var a=this._iterators;var b=a.peek().previous();if(b){b=this._findLastSubNode(b)}else{if(a.length>1){a.pop();b=a.peek().current()}else{b=null}}return b},next:function(){var c,d,b=this._iterators;d=b.peek().current();if(d&&d._nodes.size>0&&(d._expanded||this.includeInvisibleNodes)){b.push(d._nodes.iterator())}for(var a=b.length-1;a>=0;a--){c=b[a].next();if(c){break}if(b.length>1){b.pop()}}return c},createBookmark:function(){var a=[];for(var b=0;b<this._iterators.length;b++){a.push(this._iterators[b].createBookmark())}return{subIterators:this._iterators.slice(0),subBookmarks:a}},restoreBookmark:function(b){this._iterators=b.subIterators;for(var a=0;a<this._iterators.length;a++){this._iterators[a].restoreBookmark(b.subBookmarks[a])}}});dorado.widget.tree.TreeNodeIterator.getNodeIndex=function(c){var a=-1,d=c._parent;while(d){if(!d._expanded&&!this.includeInvisibleNodes){return -1}var b=d._nodes.iterator();
a++;while(b.hasNext()){var e=b.next();if(e==c){break}a++;if(e._expanded||this.includeInvisibleNodes){a+=e._visibleChildNodeCount}}c=d;d=c._parent}return a};dorado.widget.tree.ItemModel=$extend(dorado.widget.list.ItemModel,{$className:"dorado.widget.tree.ItemModel",constructor:function(){this._itemMap={};$invokeSuper.call(this,arguments)},onNodeAttached:function(a){this._itemMap[a._id]=a},onNodeDetached:function(a){delete this._itemMap[a._id]},iterator:function(c){var a=c;if(a===undefined){a=this._startIndex||0}var b=new dorado.widget.tree.TreeNodeIterator(this._root,{nextIndex:a});return b},getItems:function(){return this._root},setItems:function(a){this._root=a},getItemCount:function(){var a=this._root;return(a._expanded)?a._visibleChildNodeCount:0},getItemAt:function(a){return new dorado.widget.tree.TreeNodeIterator(this._root,{nextIndex:a}).next()},getItemIndex:dorado.widget.tree.TreeNodeIterator.getNodeIndex,getItemId:function(a){return a._id},getItemById:function(a){return this._itemMap[a]
}});dorado.widget.tree.TreeNodeRenderer=$extend(dorado.Renderer,{createIconDom:function(a){var b=document.createElement("LABEL");b.className="icon";return b},getLabel:function(a){return a.get("label")},renderLabel:function(e,c,d){var b=d._tree,a={dom:e,label:c,node:d,processDefault:(b.getListenerCount("onRenderNode")==0)};if(b){b.fireEvent("onRenderNode",b,a)}if(a.processDefault){e.innerText=c;e.title=d.get("tip")||""}},createCheckboxDom:function(a){return new dorado.widget.CheckBox({iconOnly:true,onValueChange:function(c,b){var e=a.findItemDomByEvent(c.getDom());var d=$fly(e).data("item");d.set("checked",c.get("checked"));c.set("checked",d.get("checked"))}})},doRender:function(cell,node){var tree=node._tree;cell.style.paddingLeft=((node.get("level")-1)*tree._indent)+"px";var cls=["collapse-button","expand-button"],buttonDom=cell.firstChild,$buttonDom=jQuery(buttonDom);if(node.get("hasChild")){if(node._expanded){cls.reverse()}$buttonDom.removeClass(cls[0]).addClass(cls[1])}else{$buttonDom.removeClass(cls[0]).removeClass(cls[1])
}$buttonDom.toggleClass("button-expanding",!!node._expanding);if(!cell.lastChild){eval("debugger")}this.renderLabel(cell.lastChild,this.getLabel(node),node);var icon,iconClass;if(node._expanded){icon=node.get("expandedIcon")||tree._defaultExpandedIcon;iconClass=node.get("expandedIconClass")||tree._defaultExpandedIconClass}icon=icon||node.get("icon")||tree._defaultIcon;iconClass=iconClass||node.get("iconClass")||tree._defaultIconClass;if(cell.doradoHasIcon){if(!icon){cell.removeChild(cell.childNodes[1]);cell.doradoHasIcon=false}}else{if(icon||iconClass){cell.insertBefore(this.createIconDom(tree),cell.childNodes[1]);cell.doradoHasIcon=true}}var iconDom=cell.childNodes[1];if(icon){$DomUtils.setBackgroundImage(iconDom,icon)}else{if(iconClass){$fly(iconDom).addClass(iconClass)}}var checkable=node.get("checkable"),checkbox;if(cell.subCheckboxId){checkbox=dorado.widget.Component.ALL[cell.subCheckboxId];if(!checkable){checkbox.unrender();tree.unregisterInnerControl(checkbox);checkbox.destroy();
cell.subCheckboxId=null}}else{if(checkable){checkbox=this.createCheckboxDom(tree),checkboxIndex=cell.doradoHasIcon?2:1;checkbox.render(cell,cell.childNodes[checkboxIndex]);tree.registerInnerControl(checkbox);cell.subCheckboxId=checkbox._uniqueId}}if(checkable&&checkbox){checkbox.set("checked",node.get("checked"));checkbox.refresh()}},render:function(b,a){this.doRender(b.firstChild,a)}});dorado.widget.AbstractTree=$extend(dorado.widget.RowList,{$className:"dorado.widget.AbstractTree",selectable:false,ATTRIBUTES:{root:{readOnly:true},nodes:{setter:function(b,a){this._root.addNodes(a)},getter:function(){return this._root._nodes}},currentNode:{skipRefresh:true,setter:function(b,a){if(this._currentNode==a){return}if(a==this._root){a=null}var c={oldCurrent:this._currentNode,newCurrent:a,processDefault:true};this.fireEvent("beforeCurrentChange",this,c);if(!c.processDefault){return}this._currentNode=a;this.fireEvent("onCurrentChange",this,c);if(this._rendered){$setTimeout(this,function(){var d=a?this._itemDomMap[a._id]:null;
this.setCurrentRow(d);if(d){this.scrollCurrentIntoView()}},50)}}},indent:{defaultValue:16},expandingMode:{defaultValue:"async",skipRefresh:true},dropMode:{defaultValue:"onItem",setter:function(b,a){if(a=="insertItems"){a="onOrInsertItems"}this._dropMode=a}},expandingAnimated:{defaultValue:true,skipRefresh:true},defaultIcon:{},defaultIconClass:{},defaultExpandedIcon:{},defaultExpandedIconClass:{},firstNode:{readOnly:true,getter:function(){return this._root.get("firstNode")}}},EVENTS:{beforeExpand:{disallowMultiListeners:true},onExpand:{},beforeCollapse:{},onCollapse:{},onNodeAttached:{},onNodeDetached:{},beforeCurrentChange:{},onCurrentChange:{},onRenderNode:{},beforeNodeCheckedChange:{},onNodeCheckedChange:{}},constructor:function(){var a=this._root=this.createRootNode();a._setTree(this);a._expanded=true;this._autoRefreshLock=0;$invokeSuper.call(this,arguments)},destroy:function(){if(this._scrollMode!="viewport"){this._root._setTree(null)}$invokeSuper.call(this,arguments)},createRootNode:function(){return new dorado.widget.tree.Node("<ROOT>")
},createItemModel:function(){var a=new dorado.widget.tree.ItemModel();a.setItems(this._root);return a},createItemDom:function(a){var b=a._dom;if(!b||b.parentNode!=null){b=document.createElement("TR");b.className="row";b.style.height=this._rowHeight+"px";if(this._scrollMode=="lazyRender"&&this._shouldSkipRender){b._lazyRender=true}else{this.createItemDomDetail(b,a)}}return b},createItemDomDetail:function(f,e){var b=$DomUtils.xCreateElement({tagName:"TD",className:"d-tree-node",content:[{tagName:"LABEL",doradoType:"tree-button",className:"button"},{tagName:"LABEL",className:"label",whiteSpace:"no-wrap"}]});var d=b.firstChild,a=jQuery(d),c=this;a.mousedown(function(){return false}).click(function(){var h=d.parentNode.parentNode;var g=$fly(h).data("item");if(g.get("hasChild")){if(g._expanded){g.collapse()}else{if(c._expandingMode=="sync"){g.expand()}else{g.expandAsync()}}a.removeClass("expand-button-hover collapse-button-hover")}return false}).hover(function(){if(a.hasClass("expand-button")){a.addClass("expand-button-hover")
}if(a.hasClass("collapse-button")){a.addClass("collapse-button-hover")}},function(){a.removeClass("expand-button-hover collapse-button-hover")});f.appendChild(b)},doRefreshItemDomData:function(b,a){(this._renderer||$singleton(dorado.widget.tree.TreeNodeRenderer)).render(b,a)},getItemTimestamp:function(a){return a.getTimestamp()},onNodeAttached:function(a){if(this._itemModel){this._itemModel.onNodeAttached(a);this.fireEvent("onNodeAttached",this,{node:a})}},onNodeDetached:function(a){if(this._itemModel){this._itemModel.onNodeDetached(a);this.fireEvent("onNodeDetached",this,{node:a})}},refreshItemDoms:function(b,a,c){if(this._duringAnimation){return}return $invokeSuper.call(this,arguments)},refreshNode:function(a){if(a){dorado.Toolkits.cancelDelayedAction(a,"$refreshDelayTimerId")}if(this._autoRefreshLock>0||!this._itemDomMap){return}var b=this._itemDomMap[a._id];if(b){this.refreshItemDomData(b,a)}},disableAutoRefresh:function(){this._autoRefreshLock++},enableAutoRefresh:function(){this._autoRefreshLock--;
if(this._autoRefreshLock<0){this._autoRefreshLock=0}},getNodeByEvent:function(a){var b=this.findItemDomByEvent(a);return(b)?$fly(b).data("item"):null},getCheckedNodes:function(){var b=new dorado.widget.tree.TreeNodeIterator(this._root,{includeInvisibleNodes:true}),a=[];while(b.hasNext()){var c=b.next();if(c.get("checked")){a.push(c)}}return a},highlightItem:function(c,b,d){if(c._tree!=this){return}var e=this._itemDomMap[c._id];if(e){$fly(e.firstChild).effect("highlight",b||{color:"#FFFF80"},d||1500)}else{if(!c._disableDelayHighlight){var a=this;setTimeout(function(){c._disableDelayHighlight=true;a.highlightItem(c,b,d);c._disableDelayHighlight=false},100)}}},initDraggingIndicator:function(f,j,g){if(this._dragMode!="control"){var e=j.get("element");if(e){var h=e.firstChild;var d=$DomUtils.xCreateElement({tagName:"div",className:"d-list-dragging-item "+h.className});var b=[];for(var c=1;c<h.childNodes.length;c++){var a=h.childNodes[c];b.push(a)}$fly(b).clone().appendTo(d);f.set("content",d)
}}},doOnDraggingSourceMove:function(h,g,i,e,a,f){var b=e;if(f){if(e){var d=this._dom,c=$fly(f).data("item");if(e=="after"&&c._expanded&&c._nodes.size){i=c;e="before";a=c.get("firstNode")}else{i=c._parent}}if(h.get("sourceControl")==this){var c=i;while(c){if(c==h.get("object")){i=null;f=null;break}c=c._parent}}}return $invokeSuper.call(this,[h,g,i,b,a,f])},showDraggingInsertIndicator:function(j,f,g){function e(k){return k.firstChild.childNodes[1].offsetLeft}if(f){var i=dorado.widget.RowList.getDraggingInsertIndicator();var d=this._dom,c=$fly(g).data("item");var b=e(g);if(j.get("targetObject")==$fly(g).data("item")){b+=this._indent}var a=d.offsetWidth;if(d.clientWidth<a){a=d.clientWidth}a-=b;var h=(f=="before")?g.offsetTop:(g.offsetTop+g.offsetHeight);$fly(i).width(a).height(2).left(b).top(h-1).show();d.appendChild(i)}else{$invokeSuper.call(this,arguments)}},processItemDrop:function(a,b){var d=a.get("object");var c=a.get("targetObject");var e=a.get("insertMode");var f=a.get("refObject");if(d instanceof dorado.widget.tree.Node&&c instanceof dorado.widget.tree.Node){d.remove();
c.addNode(d,e,f);this.highlightItem(d);return true}return false}});(function(){var a=jQuery.fx.prototype.update;jQuery.fx.prototype.update=function(){a.apply(this,arguments);if(this.elem.nodeName.toUpperCase()=="TR"){this.elem.style.display=""}};dorado.widget.Tree=$extend(dorado.widget.AbstractTree,{$className:"dorado.widget.Tree",ATTRIBUTES:{className:{defaultValue:"d-tree"},width:{defaultValue:200},rowHeight:{defaultValue:22}},getCurrentItem:function(){if(this._currentIndex>=0){return this._itemModel.getItemAt(this._currentIndex)}},getCurrentItemId:function(){return(this._currentNode)?this._currentNode._id:null},setCurrentItemDom:function(b){this.set("currentNode",b?$fly(b).data("item"):null)},doRefreshItemDomData:function(c,b){$invokeSuper.call(this,arguments);if(this._scrollMode!="viewport"){b._dom=c}},removeItemDom:function(c){if(this._scrollMode!="viewport"){if(c.parentNode){c.parentNode.removeChild(c)}}else{var b=$fly(c).data("item");if(b){delete b._dom}$invokeSuper.call(this,arguments)
}},createExpandingIndicator:function(){var b=this._expandingIndicator;if(b==null){this._expandingIndicator=b=$DomUtils.xCreateElement({tagName:"TR",className:"d-tree-expanding-placeholder",content:"^TD"})}return b},_insertChildNodes:function(d,n,e,k){var g=this._dataTBody,i=n?n.nextSibling:null;var f=new dorado.widget.tree.TreeNodeIterator(d),h=0,b=-1;while(f.hasNext()){var c=f.next();var m=this.createItemDom(c);if(e&&!this._duringAnimation){m.style.display="none"}(i)?g.insertBefore(m,i):g.appendChild(m);if(h>10&&!this._shouldSkipRender){if(b<0){b=this._container.scrollTop+this._container.clientHeight}if(m.offsetTop+m.offsetHeight>b){this._shouldSkipRender=true}}this.refreshItemDom(g,c,m.sectionRowIndex);h++}this._shouldSkipRender=false;if(e&&!this._duringAnimation){var j=this.createExpandingIndicator(),l=this;j.style.height=0;(i)?g.insertBefore(j,i):g.appendChild(j);this._duringAnimation=true;$fly(j).animate({height:"+="+(l._rowHeight*h)},200,"swing",function(){$fly(j).remove();f=new dorado.widget.tree.TreeNodeIterator(d);
while(f.hasNext()){var p=f.next(),o=l._itemDomMap[p._id];if(o){o.style.display=""}}l.notifySizeChange();$callback(k,true,d);l._duringAnimation=false})}else{this.notifySizeChange();$callback(k,true,d)}},_removeChildNodes:function(c,f,k){var h=new dorado.widget.tree.TreeNodeIterator(c);var d=[];while(h.hasNext()){var b=h.next();if(b==this._currentNode){this.set("currentNode",c)}var e=this._itemDomMap[b._id];if(e){d.push(e)}}if(d.length){if(f&&!this._duringAnimation){var j=this.createExpandingIndicator();j.style.height=(this._rowHeight*d.length)+"px";this._dataTBody.insertBefore(j,d[0])}for(var g=0;g<d.length;g++){var m=d[g];this.removeItemDom(m)}if(f&&!this._duringAnimation){var l=this;this._duringAnimation=true;$fly(j).animate({height:0},200,"swing",function(){$fly(j).remove();l.notifySizeChange();if(k){$callback(k,true,c)}l._duringAnimation=false})}}else{this.notifySizeChange();if(k){$callback(k,true,c)}}},_refreshAndScroll:function(c,h,g,d){var l=false,p=this._itemModel;if(g._expanded){var q=this._itemDomMap[c._id];
if(!q){var k;if(h=="remove"){k=p.getItemIndex(g)+1;var f=g._nodes.iterator();var e=0;while(f.hasNext()&&e<d){var b=f.next();k++,e++;if(b._expanded){k+=b._visibleChildNodeCount}}}else{k=p.getItemIndex(c)}if(k>=0){var m=p.getStartIndex();switch(h){case"insert":if(k<m){p.setStartIndex(m+c._visibleChildNodeCount+1);l=true}break;case"remove":if((k+c._visibleChildNodeCount+1)<m){p.setStartIndex(m-c._visibleChildNodeCount-1);l=true}else{if(k<m){p.setStartIndex(k);l=true}}break;case"expand":if(k<m){p.setStartIndex(m+c._visibleChildNodeCount);l=true}break;case"collapse":if((k+c._visibleChildNodeCount)<m){p.setStartIndex(m-c._visibleChildNodeCount);l=true}else{if(k<m){p.setStartIndex(k+1);l=true}}break}}}this.refreshDom(this._dom);if(l){this._container.scrollTop=this._scrollTop=this._dataTBody.offsetTop}}else{var j=false;switch(h){case"insert":j=g._nodes.size==1;break;case"remove":j=!g.get("hasChild");break}if(j){var o=this._itemDomMap[g._id];if(o){this._ignoreItemTimestamp=true;this.refreshItemDomData(o,g)
}}}},_getExpandingAnimated:function(){return this._expandingAnimated},_nodeExpanded:function(b,d){if(!this._rendered||!this._attached||this._autoRefreshLock>0){return}if(this._scrollMode!="viewport"){if(b==this._root){this._insertChildNodes(b,null,this._getExpandingAnimated(),d);this.notifySizeChange()}else{var c=this._itemDomMap[b._id];if(c){this._insertChildNodes(b,c,this._getExpandingAnimated(),d);this.refreshItemDomData(c,b)}}}else{this._refreshAndScroll(b,"expand",b._parent);if(d){$callback(d,true,b)}}},_nodeCollapsed:function(b,d){if(!this._rendered||!this._attached||this._autoRefreshLock>0){return}if(this._scrollMode!="viewport"){this._removeChildNodes(b,this._getExpandingAnimated(),d);var c=this._itemDomMap[b._id];if(c){this.refreshItemDomData(c,b)}}else{this._refreshAndScroll(b,"collapse",b._parent);if(d){$callback(d,true,b)}}},_nodeInserted:function(b){if(!this._rendered||!this._attached||this._autoRefreshLock>0){return}if(this._scrollMode!="viewport"){var g=b._parent;if(g._expanded){var c=this._itemModel.getItemIndex(b);
if(c>=0){var f=b._expanded;b._expanded=false;try{var d=new dorado.widget.tree.TreeNodeIterator(this._itemModel.getItems(),{nextIndex:c});d.next();var i=d.next(),e=this._dataTBody,h}finally{b._expanded=f}if(i){h=this._itemDomMap[i._id]}var k=this.createItemDom(b);(h)?e.insertBefore(k,h):e.appendChild(k);this.refreshItemDom(e,b,k.sectionRowIndex);if(f){this._insertChildNodes(b,k)}this.notifySizeChange()}}if(g&&g._nodes.size==1){var j=this._itemDomMap[g._id];if(j){this._ignoreItemTimestamp=true;this.refreshItemDomData(j,g)}}}else{this._refreshAndScroll(b,"insert",b._parent)}},_nodeRemoved:function(d,b,c){if(!this._rendered||!this._attached||this._autoRefreshLock>0){return}if(this._scrollMode!="viewport"){if(b){if(b._expanded){if(d._expanded){this._removeChildNodes(d)}var f=this._itemDomMap[d._id];if(f){this.removeItemDom(f)}}if(!b.get("hasChild")){var e=this._itemDomMap[b._id];if(e){this._ignoreItemTimestamp=true;this.refreshItemDomData(e,b)}}this.notifySizeChange()}}else{this._refreshAndScroll(d,"remove",b,c)
}}})})();dorado.widget.tree.DataBindingNode=$extend(dorado.widget.tree.DataNode,{$className:"dorado.widget.tree.DataBindingNode",ATTRIBUTES:{bindingConfig:{writeOnce:true},childBindingConfigs:{writeOnce:true,setter:function(b,a){this._bindingConfig.childBindingConfigs=a},getter:function(){return this._bindingConfig.childBindingConfigs}},hasChild:{getter:function(){function b(h,k){if(!k){return false}var j=false,i=h._data[k];if(h instanceof dorado.Entity){if(i===undefined){if(h.dataType){var g=h.dataType.getPropertyDef(k);j=(g.getDataPipe&&g.getDataPipe(h)!=null)}}else{if(i){if(i.isDataPipeWrapper||typeof i=="object"&&!(i instanceof Date)){j=true}}}}else{i=h[k];if(i&&typeof i=="object"&&!(i instanceof Date)){j=true}}return j}if(this._nodes.size>0){return true}if(this._hasChild!=undefined){return this._hasChild}if(this._bindingConfig._hasChildProperty!=undefined){return this._getEntityProperty(this._data,this._bindingConfig._hasChildProperty)}var f=false;if(this._data&&(this._bindingConfig.recursive||this._bindingConfig.childBindingConfigs)){var c=this._data,e;
if(c instanceof dorado.Entity){f=b(c,this._bindingConfig.childrenProperty);if(!f){var a=this._bindingConfig.childBindingConfigs;if(a){for(var d=0;d<a.length;d++){f=b(c,a[d].childrenProperty);if(f){break}}}}}}return f}},label:{getter:function(){if(this._label){return this._label}return this._getEntityProperty(this._data,this._bindingConfig.labelProperty)}},icon:{getter:function(){if(this._icon){return this._icon}var a=this._bindingConfig;if(a.icon){return a.icon}return this._getEntityProperty(this._data,a.iconProperty)}},iconClass:{getter:function(){if(this._iconClass){return this._iconClass}var a=this._bindingConfig;if(a.iconClass){return a.iconClass}return this._getEntityProperty(this._data,a.iconClassProperty)}},expanededIcon:{getter:function(){if(this._expanededIcon){return this._expanededIcon}var a=this._bindingConfig;if(a.expanededIcon){return a.expanededIcon}return this._getEntityProperty(this._data,a.expanededIconProperty)}},expanededIconClass:{getter:function(){if(this._expanededIconClass){return this._expanededIconClass
}var a=this._bindingConfig;if(a.expanededIconClass){return a.expanededIconClass}return this._getEntityProperty(this._data,a.expanededIconClassProperty)}},checkable:{getter:function(){return this._checkable||this._bindingConfig.checkable}},checked:{getter:function(){var a=this._bindingConfig;if(a.checkedProperty&&this._data){this._checked=this._getEntityProperty(this._data,a.checkedProperty)}if(this._checked!=undefined){return this._checked}return a.checked},setter:function(f,d){var c=this._checked,b=this._bindingConfig;if(c==undefined){c=b.checked}if(c===d){return}$invokeSuper.call(this,arguments);var a=this._data,e=b.checkedProperty;if(a&&e){(a instanceof dorado.Entity)?a.set(e,d):a[e]=d}}},tip:{getter:function(){if(this._tip){return this._tip}return this._getEntityProperty(this._data,this._bindingConfig.tipProperty)}}},_prepareChildren:function(k){function g(t,q,u,n){function o(y){var C={data:y,processDefault:true};v.fireEvent("beforeDataNodeCreate",v,C);if(!C.processDefault){return}var A=null,B=null;
if(u<i.size){A=i.get(u);if(A._data!=y){B=A;A=null}}if(!A){A=new dorado.widget.tree.DataBindingNode({bindingConfig:t,data:y,tags:t.tags});if(B){i.replace(B,A)}else{i.insert(A)}}else{A._bindingConfig=t;A._parent._changeVisibleChildNodeCount(1)}C.node=A;v.fireEvent("onDataNodeCreate",v,C);var x=s[y.entityId];if(x===true||A._expanded){A._expanded=false;A.expandAsync()}else{if(n){if(!t.recursive){if(!t.recursive&&t.expandLevel){A.expandAsync()}}else{if(t.expandLevel){var w=A._parent,z=0;while(w&&w._bindingConfig==t){w=w._parent;z++}if(z<t.expandLevel){A.expandAsync()}}}}}}var v=this._tree,i=this._nodes,s={};for(var r=i.iterator();r.hasNext();){var p=r.next();if(p._data){s[p._data.entityId]=!!p._expanded}}if(q instanceof dorado.EntityList){for(var r=q.iterator();r.hasNext();){o(r.next());u++}return u}else{if(q instanceof dorado.Entity){o(q);u++}}return u}this._childrenPrepared=true;var f=this._bindingConfig,m=this._tree;var b=(this==m._root);var d=this._data;if(b&&m){this._data=d=m.getBindingData({firstResultOnly:true,acceptAggregation:true})
}if(!d){this._clearChildren();return}var a=[],l=this;if(k&&d instanceof dorado.Entity){var e=(this._parent==m._root);if(f.recursive&&!b){a.push(function(n){if(e){var i=dorado.widget.DataTree.bindingConfigToPreloadConfig(f,1);if(i){dorado.DataProvider._SYS_PARAMETER={preloadConfigs:i}}}d.getAsync(f.childrenProperty,n);dorado.DataProvider._SYS_PARAMETER=null})}if(f.childBindingConfigs){for(var c=0;c<f.childBindingConfigs.length;c++){var j=f.childBindingConfigs[c];var h=j.childrenProperty;a.push(function(n){if(e){var i=dorado.widget.DataTree.bindingConfigToPreloadConfig(j,1);if(i){dorado.DataProvider._SYS_PARAMETER={preloadConfigs:i}}}d.getAsync(h,n);dorado.DataProvider._SYS_PARAMETER=null})}}}$waitFor(a,{callback:function(v,x){var p=0,t=[];if(d instanceof dorado.Entity){if(f.recursive){var s=(b)?d:d.get(f.childrenProperty,k?"auto":"always");if(s){p+=s.timestamp;t.push({bindingConfig:f,data:s})}}if(f.childBindingConfigs){for(var q=0;q<f.childBindingConfigs.length;q++){var w=f.childBindingConfigs[q];
var s=d.get(w.childrenProperty,k?"auto":"always");if(!s){continue}p+=s.timestamp;t.push({bindingConfig:w,data:s})}}}else{if(b){var r=f.childBindingConfigs;if(r&&r.length==1){p+=d.timestamp;t.push({bindingConfig:r[0],data:d})}}}if(l._nodesTimestamp!=p){l._nodesTimestamp=p;l._visibleChildNodeCount=0;var u=0;if(m){m.disableAutoRefresh()}try{for(var q=0;q<t.length;q++){var o=t[q];u=g.call(l,o.bindingConfig,o.data,u,!l._hasExpanded)}var n=l._nodes;for(var q=n.size-1;q>u;q--){n.removeAt(q)}if(u==0){l._hasChild=false}}finally{if(m){m.enableAutoRefresh()}}}if(k){$callback(k,v,x)}}})},_clearChildren:function(){delete this._nodesTimestamp;this._childrenPrepared=false},doExpand:function(){if(!this._childrenPrepared){this._prepareChildren()}$invokeSuper.call(this,arguments)},doExpandAsync:function(c){if(!this._childrenPrepared){var a=this,b=$getSuperClass();this._prepareChildren({callback:function(e,d){if(!a._expanded){b.prototype.doExpandAsync.call(a,c)}}})}else{$invokeSuper.call(this,arguments)}},doCollapse:function(){$invokeSuper.call(this,arguments);
this._clearChildren()},rebuildChildNodes:function(){var a=this._tree;a.disableBinding();var c=a._expandingAnimated;a._expandingAnimated=false;try{var b=this._expanded;if(b){this.doCollapse()}this.clearChildren();if(b){this.doExpandAsync($scopify(this,function(){if(a._currentNode&&a._currentNode._tree!=a){a.set("currentNode",this)}}))}}finally{a._expandingAnimated=true}a.enableBinding()}});dorado.widget.DataTree=$extend([dorado.widget.Tree,dorado.widget.DataControl],{$className:"dorado.widget.DataTree",ATTRIBUTES:{bindingConfigs:{writeBeforeReady:true,setter:function(b,a){this._root.set("childBindingConfigs",a)},getter:function(){return this._root.get("childBindingConfigs")}},dataPathInterceptor:{writeBeforeReady:true},currentEntity:{setter:function(c,a){var b=a?this._entityMap[a.entityId]:null;this.set("currentNode",b)},getter:function(){return(this._currentNode)?this._currentNode._data:null}}},EVENTS:{beforeDataNodeCreate:{},onDataNodeCreate:{}},constructor:function(){this._entityMap={};
$invokeSuper.call(this,arguments)},onReady:function(){if(this._dataPathInterceptor){var a=this;dorado.DataPath.registerInterceptor(this._dataPathInterceptor,function(b){return a.get("currentNode.data")},function(c){var b=a.get("currentNode.data");return b?b.dataType:c});this.addListener("onCurrentChange",function(){a.disableBinding();a.get("dataSet").notifyObservers();a.enableBinding()})}$invokeSuper.call(this,arguments)},createRootNode:function(){return new dorado.widget.tree.DataBindingNode({label:"<ROOT>",bindingConfig:{}})},syncCurrentEntity:function(){var b=[];var a=this.get("currentEntity");while(a&&a.parent){b.push({entityList:a.parent,entity:a});a=a.parent.parent}jQuery.each(b.reverse(),function(c,d){if(d.entityList.current!=d.entity){d.entityList.setCurrent(d.entity)}})},onNodeAttached:function(a){$invokeSuper.call(this,arguments);if(a._data){this._entityMap[a._data.entityId]=a}},onNodeDetached:function(a){$invokeSuper.call(this,arguments);if(a._data){delete this._entityMap[a._data.entityId]
}},refresh:function(){if(this._dataSet){var b=!this._root._childrenPrepared;if(!b){var a=this.getBindingData({firstResultOnly:true,acceptAggregation:true});if(this._data!=a){b=true;this._data=a}}if(b){this._root._prepareChildren(dorado._NULL_FUNCTION)}}$invokeSuper.call(this,arguments)},filterDataSetMessage:function(b,a){switch(b){case dorado.widget.DataSet.MESSAGE_REFRESH:case dorado.widget.DataSet.MESSAGE_DATA_CHANGED:case dorado.widget.DataSet.MESSAGE_REFRESH_ENTITY:case dorado.widget.DataSet.MESSAGE_DELETED:case dorado.widget.DataSet.MESSAGE_INSERTED:case dorado.widget.DataSet.MESSAGE_ENTITY_STATE_CHANGED:return true;case dorado.widget.DataSet.MESSAGE_CURRENT_CHANGED:if(this._data){if(dorado.DataUtil.isOwnerOf(this._data,a.entityList)){return true}}return false;default:return false}},processDataSetMessage:function(c,b,f){switch(c){case dorado.widget.DataSet.MESSAGE_REFRESH:case dorado.widget.DataSet.MESSAGE_CURRENT_CHANGED:this.refresh(true);break;case dorado.widget.DataSet.MESSAGE_DATA_CHANGED:case dorado.widget.DataSet.MESSAGE_REFRESH_ENTITY:case dorado.widget.DataSet.MESSAGE_ENTITY_STATE_CHANGED:this.refreshNodeByEntity(b.entity);
break;case dorado.widget.DataSet.MESSAGE_DELETED:var e=this._entityMap[b.entity.entityId];if(e){e.remove()}break;case dorado.widget.DataSet.MESSAGE_INSERTED:var d=b.entity.parent,g;if(d){if(d instanceof dorado.EntityList){g=d;d=d.parent}}var a;if(d instanceof dorado.Entity){a=this._entityMap[d.entityId]}else{if(g==this._root._data){a=this._root}}if(a&&a._expanded){if(this._scrollMode=="simple"){a.rebuildChildNodes()}else{this.disableAutoRefresh();a._prepareChildren();this.enableAutoRefresh();this.refresh(true)}}break}},refreshNodeByEntity:function(a){var b=this._entityMap[a.entityId];if(!b){return}this.refreshNode(b)},rebuildNodes:function(){delete this._root._data;this._root.rebuildChildNodes()},processItemDrop:function(o,m){var e=o.get("object");var p=o.get("targetObject");var j=o.get("insertMode");var a=o.get("refObject");if(e instanceof dorado.widget.tree.DataBindingNode&&p instanceof dorado.widget.tree.DataBindingNode){var d=e,i=p;var k=d.get("data"),q=i.get("data");var g,b;if(a instanceof dorado.widget.tree.DataBindingNode){g=a;
b=g.get("data")}var l=d.get("bindingConfig");var h=i.get("bindingConfig");var f=i.get("childBindingConfigs")||[];var n;if(l==h||h.recursive&&f.indexOf(l)>=0){n=l}else{if(f.length==1&&!h.recursive){n=f[0]}else{if(f.length==0&&h.recursive){n=h}}}if(n){var c;if(q instanceof dorado.EntityList){c=q}else{c=q.get(n.childrenProperty,"always")}if(c instanceof dorado.EntityList){k.remove();k=c.createChild(k.toJSON(),true);c.insert(k,j,b);return true}}}return false}});dorado.widget.DataTree.bindingConfigToPreloadConfig=function(c,g){function a(i,k){var h={property:i.childrenProperty,recursiveLevel:i.recursive?(i.expandLevel-k-1):0};var j=f(i,k);if(j){h.childPreloadConfigs=j}return h}function f(j,m){var l=[];if(j.childBindingConfigs){for(var k=0;k<j.childBindingConfigs.length;k++){var h=a(j.childBindingConfigs[k],0);l.push(h)}}return(l.length)?l:null}g=g||0;var e=[];if(c.recursive||c.expandLevel>0){if(c.recursive){if(c.expandLevel>g){var b=a(c,g);e.push(b)}}var d=f(c,g);if(d){e=e.concat(d)}}return e
};