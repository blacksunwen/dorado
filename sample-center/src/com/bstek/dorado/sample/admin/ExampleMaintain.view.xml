<?xml version="1.0" encoding="UTF-8"?>
<ViewConfig template="com.bstek.dorado.sample.admin.AdminViewTemplate">
  <Arguments>
    <Argument name="caption" value="示例结构维护"/>
  </Arguments>
  <Context/>
  <Model>
    <DataType name="Node" meta="child:ExampleSource,CategoryNode,ExampleNode,global:ExampleSource">
      <ClientEvent name="onStateChange">if (arg.oldState == dorado.Entity.STATE_NONE) {
	this.$dirtyEntityNum++;
}
else if (arg.newState == dorado.Entity.STATE_NONE) {
	this.$dirtyEntityNum--;
}
else if (arg.oldState == dorado.Entity.STATE_NEW &amp;&amp; arg.newState == dorado.Entity.STATE_DELETED) {
	this.$dirtyEntityNum--;
}
this.$refreshActions();
</ClientEvent>
      <ClientEvent name="onRemove">
arg.entity.set(&quot;sortFlag&quot;, 0);
</ClientEvent>
      <ClientEvent name="onInsert">
var entityList = arg.entityList;
var maxSortFlag = 0;
entityList.each(function(entity) {
	var sortFlag = entity.get(&quot;sortFlag&quot;);
	if (sortFlag &lt;= maxSortFlag) {
		maxSortFlag++;
		entity.set(&quot;sortFlag&quot;, maxSortFlag);
	}
	else {
		maxSortFlag = sortFlag;
	}
});
</ClientEvent>
    </DataType>
    <DataType name="CategoryNode" parent="ExampleCategory,Node">
      <Reference name="categories" dataProvider="exampleMaintain#getCategories" dataType="[CategoryNode]" parameter="$${this.id}"/>
      <Reference name="examples" dataProvider="exampleMaintain#getExamplesByCategoryId" dataType="[ExampleNode]" parameter="$${this.id}"/>
    </DataType>
    <DataType name="ExampleNode" parent="Example,Node">
      <PropertyDef name="sortFlag" dataType="int"/>
      <PropertyDef name="sources" dataType="[ExampleSource]"/>
    </DataType>
    <DataType name="ExampleSource" parent="global:ExampleSource,Node"/>
  </Model>
  <View title="${argument.caption}">
    <ClientEvent name="onCreate">
this.$dirtyEntityNum = 0;

this.$refreshActions = function() {
	var node = this.id(&quot;treeExamples&quot;).get(&quot;currentNode&quot;);
	$tag(&quot;onCurrentNode&quot;).set(&quot;disabled&quot;, node == null);
	$tag(&quot;onCurrentCategory&quot;).set(&quot;disabled&quot;, (node == null || node.get(&quot;bindingConfig.name&quot;) != &quot;Category&quot;));
	$tag(&quot;onCurrentExample&quot;).set(&quot;disabled&quot;, (node == null || node.get(&quot;bindingConfig.name&quot;) != &quot;Example&quot;));
	
	var disabled = true;
	if (node != null) {
		var entity = node.get(&quot;data&quot;);
		disabled = !entity.isDirty();
	}
	$tag(&quot;onDirtyNode&quot;).set(&quot;disabled&quot;, disabled);
	
	$tag(&quot;onDirty&quot;).set(&quot;disabled&quot;, this.$dirtyEntityNum == 0);
}
</ClientEvent>
    <GroupStart id="mainContent"/>
    <DataSet id="dsCategories" dataProvider="exampleMaintain#getCategories" dataType="[CategoryNode]">
      <Property name="loadMode">onReady</Property>
    </DataSet>
    <Action id="actionAddCategory" caption="添加新分类" disabled="true" icon=">images/folder.gif" tags="onCurrentCategory">
      <ClientEvent name="onExecute">
var dataSet = this.id(&quot;dsCategories&quot;);
var parentCategory = dataSet.getData(&quot;!CURRENT_CATEGORY&quot;);
var data = { label: &quot;&lt;新分类>&quot; };
if (parentCategory) {
	parentCategory.createChild(&quot;categories&quot;, data);
}
else {
	dataSet.getData().createChild(data);
}

var currentNode = this.id(&quot;treeExamples&quot;).get(&quot;currentNode&quot;);
if (currentNode) currentNode.expandAsync();</ClientEvent>
    </Action>
    <Action id="actionAddExample" caption="添加新示例" disabled="true" icon=">images/file.gif" tags="onCurrentNode">
      <ClientEvent name="onExecute">
var dataSet = this.id(&quot;dsCategories&quot;);
var parentCategory = dataSet.getData(&quot;!CURRENT_CATEGORY&quot;);
var data = { label: &quot;&lt;新示例>&quot; };
if (parentCategory) {
	parentCategory.createChild(&quot;examples&quot;, data);
	
	var currentNode = this.id(&quot;treeExamples&quot;).get(&quot;currentNode&quot;);
	if (currentNode) currentNode.expandAsync();
}
else {
	var currentExample = dataSet.getData(&quot;!CURRENT_EXAMPLE&quot;);
	if (currentExample) currentExample.createBrother(data);
}
</ClientEvent>
    </Action>
    <Action id="actionLinkExample" caption="关联到其它分类" disabled="true" icon="url(>skin>common/icons.gif) -220px -180px" tags="onCurrentExample">
      <ClientEvent name="onExecute">
var dialogSelectExample = this.id(&quot;dialogSelectExample&quot;);
dialogSelectExample.show();
</ClientEvent>
    </Action>
    <Action id="actionRemove" caption="删除" disabled="true" icon="url(>skin>common/icons.gif) -141px 0" tags="onCurrentNode">
      <ClientEvent name="onExecute">var dataSet = this.id(&quot;dsCategories&quot;);&#xD;
var entity = dataSet.getData(&quot;!CURRENT_NODE&quot;);&#xD;
if (entity) entity.remove();</ClientEvent>
      <Property name="confirmMessage">确认要删除当前(分类或示例)吗？</Property>
    </Action>
    <Action id="actionCancel" caption="取消" disabled="true" icon="url(>skin>common/icons.gif) -280px -220px" tags="onDirtyNode">
      <ClientEvent name="onExecute">
var dataSet = this.id(&quot;dsCategories&quot;);
var entity = dataSet.getData(&quot;!CURRENT_NODE&quot;);
if (entity) entity.cancel();
</ClientEvent>
    </Action>
    <UpdateAction id="actionSave" caption="全部保存" dataResolver="exampleMaintain#saveAll" disabled="true" icon="url(>skin>common/icons.gif) -140px -20px" tags="onDirty">
      <ClientEvent name="onSuccess">this.$dirtyEntityNum = 0;
this.$refreshActions();</ClientEvent>
      <Property name="successMessage">数据保存成功。</Property>
      <Property name="hotkey">ctrl+s</Property>
      <UpdateItem dataSet="dsCategories">
        <Property name="dataPath">!DIRTY_TREE</Property>
      </UpdateItem>
    </UpdateAction>
    <Menu id="menuTree">
      <MenuItem action="actionAddCategory"/>
      <MenuItem action="actionAddExample"/>
      <MenuItem action="actionLinkExample"/>
      <Separator/>
      <MenuItem action="actionRemove"/>
    </Menu>
    <ToolBar layoutConstraint="top">
      <ToolBarButton action="actionAddCategory"/>
      <ToolBarButton action="actionAddExample"/>
      <Separator/>
      <ToolBarButton action="actionLinkExample"/>
      <Separator/>
      <ToolBarButton action="actionRemove"/>
      <ToolBarButton action="actionCancel"/>
      <Separator/>
      <ToolBarButton action="actionSave"/>
      <HtmlContainer/>
      <HtmlContainer/>
    </ToolBar>
    <SplitPanel position="260">
      <MainControl>
        <CardBook id="cardbook">
          <Panel layout="anchor">
            <Children>
              <Label layoutConstraint="left:50%; top:50%" style="whiteSpace:noWrap" text="请在左侧树中选择一个节点..."/>
            </Children>
          </Panel>
          <Panel layout="padding:16">
            <Children>
              <AutoForm cols="*" dataPath="!CURRENT_CATEGORY" dataSet="dsCategories">
                <AutoFormElement property="label" width="350"/>
                <AutoFormElement property="new" type="checkBox" width="350"/>
                <AutoFormElement property="hot" type="checkBox" width="350"/>
                <AutoFormElement property="icon" width="350"/>
                <AutoFormElement property="url"/>
                <AutoFormElement property="tags"/>
                <AutoFormElement property="summary" type="textArea"/>
              </AutoForm>
            </Children>
          </Panel>
          <Panel layout="regionPadding:16" contentOverflow="hidden">
            <Children>
              <AutoForm cols="*" dataPath="!CURRENT_EXAMPLE" dataSet="dsCategories" layoutConstraint="top">
                <AutoFormElement property="label" width="350"/>
                <AutoFormElement property="author" width="350"/>
                <AutoFormElement property="createDate" width="350"/>
                <AutoFormElement property="lastModify" width="350"/>
                <AutoFormElement property="new" type="checkBox" width="350"/>
                <AutoFormElement property="hot" type="checkBox" width="350"/>
                <AutoFormElement property="icon" width="350"/>
                <AutoFormElement property="url"/>
                <AutoFormElement property="tags"/>
                <AutoFormElement property="summary" type="textArea"/>
              </AutoForm>
              <Panel caption="源文件" collapseable="true">
                <Children>
                  <ToolBar layoutConstraint="top">
                    <DataPilot dataPath="!CURRENT_EXAMPLE.sources" dataSet="dsCategories" itemCodes="+,-,x"/>
                  </ToolBar>
                  <ListDropDown id="triggerSourceLabel" items="&lt;输入源文件名称>,视图配置文件,数据模型配置文件,视图拦截器Bean,公用拦截器Bean,页面模板文件"/>
                  <DataGrid dataPath="!CURRENT_EXAMPLE.sources" dataSet="dsCategories" dragTags="sourceEntity" draggable="true" droppable="true" droppableTags="sourceEntity" style="border:none">
                    <IndicatorColumn/>
                    <DataColumn property="label" trigger="triggerSourceLabel" width="180"/>
                    <DataColumn property="path" width="*"/>
                    <DataColumn property="summary" width="350" wrappable="true"/>
                  </DataGrid>
                </Children>
              </Panel>
            </Children>
          </Panel>
        </CardBook>
      </MainControl>
      <SideControl>
        <DataTree id="treeExamples" allowNoCurrent="true" currentNodeDataPath="CURRENT_NODE" dataSet="dsCategories" dragTags="node" draggable="true" dropMode="onOrInsertItems" droppable="true" droppableTags="node">
          <ClientEvent name="onReady">
var tree = self;
var dataTypeCategory = this.getDataType(&quot;CategoryNode&quot;);
var dataTypeExample = dataTypeCategory.getPropertyDef(&quot;examples&quot;).get(&quot;dataType.elementDataType&quot;);
dorado.DataPath.registerInterceptor(&quot;CURRENT_CATEGORY&quot;, function(data) {
	var entity = tree.get(&quot;currentNode.data&quot;);
	return (entity &amp;&amp; entity.dataType == dataTypeCategory) ? entity : null;
}, function(dataType) {
	return dataTypeCategory;
});
dorado.DataPath.registerInterceptor(&quot;CURRENT_EXAMPLE&quot;, function(data) {
	var entity = tree.get(&quot;currentNode.data&quot;);
	return (entity &amp;&amp; entity.dataType == dataTypeExample) ? entity : null;
}, function(dataType) {
	return dataTypeExample;
});
</ClientEvent>
          <ClientEvent name="onCurrentChange">
this.$refreshActions();
var nodeType = self.get(&quot;currentNode.bindingConfig.name&quot;), index = 0;
if (nodeType) index = (nodeType == &quot;Category&quot;) ? 1 : 2;
this.id(&quot;cardbook&quot;).set(&quot;currentControl&quot;, index);
</ClientEvent>
          <ClientEvent name="onContextMenu">
this.id(&quot;menuTree&quot;).show({
	position: {
		left: arg.event.pageX,
		top: arg.event.pageY
	}
});
</ClientEvent>
          <ClientEvent name="onDataNodeCreate">
var entity = arg.data;
if (entity.state == dorado.Entity.STATE_NEW) {
	setTimeout(function() {
		self.set(&quot;currentNode&quot;, arg.node);
	}, 50);
}
</ClientEvent>
          <ClientEvent name="onRenderNode">var entity = arg.node.get(&quot;data&quot;);
if (entity.isDirty()) {
	var img = &quot;>images/&quot; + ((entity.state == dorado.Entity.STATE_NEW) ? &quot;new-node.gif&quot; : &quot;modified-node.gif&quot;);
	arg.dom.innerHTML = arg.node.get(&quot;label&quot;) + &quot;&amp;nbsp;&lt;img src=\&quot;&quot; + $url(img) + &quot;\&quot;>&quot;;
	arg.processDefault = false;
}
else {
	arg.processDefault = true;
}
</ClientEvent>
          <ClientEvent name="onDraggingSourceMove">
var draggingInfo = arg.draggingInfo;
var targetNode = draggingInfo.get(&quot;targetObject&quot;);
if (targetNode) {
	var accept = (targetNode.get(&quot;bindingConfig.name&quot;) == &quot;Category&quot;);
	draggingInfo.set(&quot;accept&quot;, accept);
}
</ClientEvent>
          <BindingConfigs>
            <BindingConfig childrenProperty="categories" icon=">images/folder.gif" labelProperty="label" name="Category" recursive="true">
              <BindingConfig childrenProperty="examples" icon=">images/file.gif" labelProperty="label" name="Example"/>
            </BindingConfig>
          </BindingConfigs>
        </DataTree>
      </SideControl>
    </SplitPanel>
    <Dialog id="dialogSelectExample" buttonAlign="right" caption="请选择一个分类..." center="true" height="400" modal="true" width="400">
      <Buttons>
        <Button caption="确定" width="80">
          <ClientEvent name="onClick">
var treeCategories = this.id(&quot;treeCategories&quot;);
var treeExamples = this.id(&quot;treeExamples&quot;);
var category = treeCategories.get(&quot;currentNode.data&quot;);
if (!category) {
	dorado.MessageBox.alert(&quot;请选择一个有效的分类。&quot;);
	return;
}

var currentCategoryNode = treeExamples.get(&quot;currentNode&quot;);
if (currentCategoryNode.get(&quot;bindingConfig.name&quot;) == &quot;Example&quot;) currentCategoryNode = currentCategoryNode.get(&quot;parent&quot;);
if (category == currentCategoryNode.get(&quot;data&quot;)) {
	dorado.MessageBox.alert(&quot;请选择一个不同的分类。&quot;);
	return;
}

var dialogSelectExample = this.id(&quot;dialogSelectExample&quot;);
var example = treeExamples.get(&quot;currentNode.data&quot;);
example = example.clone();
example.set(&quot;sortFlag&quot;, 0);
category.get(&quot;examples&quot;).insert(example);
dialogSelectExample.hide();
</ClientEvent>
        </Button>
        <Button caption="取消" width="60">
          <ClientEvent name="onClick">
var dialogSelectExample = this.id(&quot;dialogSelectExample&quot;);
dialogSelectExample.hide();
</ClientEvent>
        </Button>
      </Buttons>
      <Children>
        <DataTree id="treeCategories" dataSet="dsCategories">
          <BindingConfigs>
            <BindingConfig childrenProperty="categories" icon=">images/folder.gif" labelProperty="label" name="Category" recursive="true"/>
          </BindingConfigs>
        </DataTree>
      </Children>
    </Dialog>
    <GroupEnd/>
  </View>
</ViewConfig>
