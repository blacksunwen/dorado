<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:artifact="antlib:org.apache.maven.artifact.ant" name="jars" default="build">
	<taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant">
		<classpath>
			<pathelement location="${lib.dir}/${ivy.jar}" />
			<pathelement location="${lib.dir}/${oro.jar}" />
		</classpath>
	</taskdef>
	<typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="antlib:org.apache.maven.artifact.ant">
		<classpath>
			<pathelement location="${lib.dir}/maven-ant-tasks-2.1.3.jar" />
		</classpath>
	</typedef>

	<target name="clean">
		<delete dir="${work.dir}" />
		<delete dir="${target.dir}" />
	</target>

	<target name="prepare-work-dir" depends="clean">
		<mkdir dir="${work.dir}" />
		<mkdir dir="${work.dir}/lib" />
		<mkdir dir="${work.dir}/repository" />
		<mkdir dir="${target.lib.dir}" />
		<mkdir dir="${target.src.dir}" />
		<mkdir dir="${target.pom.dir}" />

		<copy file="${ivy.home}/ivysettings.properties" todir="${work.dir}" />
		<copy file="${ivy.home}/ivysettings.xml" tofile="${work.dir}/ivysettings-include.xml" />
		<copy file="${resources.dir}/ivysettings.xml" todir="${work.dir}" />

		<propertyfile file="${work.dir}/ivysettings.properties">
			<entry key="product.revision" value="${product.revision}" />
			<entry key="product.status" value="${product.status}" />
			<entry key="product.publication" value="${product.publication}" />
			<entry key="default-resolver" value="building" />
			<entry key="cache.dir" value="${ivy.cache}" />
			<entry key="temp-repository.dir" value="${work.dir}/repository" />
		</propertyfile>

		<ivy:configure file="${work.dir}/ivysettings.xml" />
	</target>

	<target name="package-module">
		<property name="module.projects" value="${module}" />
		<propertycopy name="module.projects" from="module.${module}.projects" override="true" silent="true" />
		<if>
			<equals arg1="${module.projects}" arg2="" />
			<then>
				<property name="module.projects" value="${module}" />
			</then>
		</if>

		<echo message="module: ${module}" />
		<echo message="module.projects: ${module.projects}" />
		<ant antfile="${basedir}/includes/jar.xml" inheritRefs="true" />
	</target>

	<target name="package" depends="prepare-work-dir">
		<foreach list="${product.modules}" param="module" target="package-module" inheritall="true" />
	</target>

	<target name="copy-javadoc-sources">
		<copy todir="${javadoc.src}">
			<fileset dir="${work.dir}/${module}/src">
				<include name="**/*.java" />
				<include name="**/*.html" />
				<exclude name="com/bstek/dorado/console/**" />
				<exclude name="com/bstek/dorado/ide-support/**" />
			</fileset>
		</copy>
	</target>

	<target name="javadoc" if="javadoc">
		<property name="javadoc.dist" value="${standard-edition.dir}/docs/javadoc" />
		<property name="javadoc.src" value="${work.dir}/javadoc" />

		<mkdir dir="${javadoc.src}" />
		<foreach list="${product.modules}" param="module" target="copy-javadoc-sources" inheritall="true" />

		<delete dir="${javadoc.dist}" />
		<mkdir dir="${javadoc.dist}" />

		<path id="classpath">
			<fileset dir="${work.dir}/lib">
				<include name="*.jar" />
				<exclude name="dorado-*" />
			</fileset>
		</path>

		<javadoc access="protected" author="true" encoding="UTF-8" docencoding="UTF-8" charset="UTF-8" destdir="${javadoc.dist}" doctitle="Dorado 7 Server Side API Documentation" nodeprecated="false" nodeprecatedlist="false" noindex="false" nonavbar="false" notree="false" source="1.5" splitindex="true" use="true" version="true" useexternalfile="yes">
			<classpath refid="classpath" />
			<fileset dir="${javadoc.src}" />
			<doctitle><![CDATA[<h1>Dorado7 Server Side API</h1>]]></doctitle>
			<bottom><![CDATA[<i>Copyright &#169; 2001-2011 www.BSTEK.com All Rights Reserved.</i>]]></bottom>
			<link href="http://bsdn.org/projects/dorado7/deploy/javadoc" />
		</javadoc>
		<copy file="${resources.dir}/stylesheet.css" todir="${javadoc.dist}" overwrite="true" />
	</target>

	<target name="publish-module-to-bsdn">
		<echo message="publish-to-bsdn: ${target.lib.dir}/${product.name}-${module}-${product.revision}.jar" />

		<artifact:deploy file="${target.lib.dir}/${product.name}-${module}-${product.revision}.jar" settingsfile="${resources.dir}/maven-settings.xml">
			<remoteRepository url="${maven.repository}">
				<authentication username="${bsdn.nexus.user}" password="${bsdn.nexus.password}" />
			</remoteRepository>
			<pom file="${target.pom.dir}/${product.name}-${module}.pom" />
			<attach file="${target.src.dir}/${product.name}-${module}-${product.revision}-sources.jar" type="jar" classifier="sources" />
		</artifact:deploy>
	</target>

	<target name="publish-to-bsdn">
		<echo message="publish-to-bsdn: ${maven.repository}" />

		<copy file="${resources.dir}/dorado-parent.pom" todir="${target.pom.dir}" />
		<replace dir="${target.pom.dir}" token="%product.revision%" value="${product.revision}" encoding="utf-8">
			<include name="dorado-parent.pom" />
		</replace>

		<echo message="publish-to-bsdn: ${work.dir}/dorado-parent.pom" />
		<artifact:deploy file="${work.dir}/dorado-parent.pom" settingsfile="${resources.dir}/maven-settings.xml">
			<remoteRepository url="${maven.repository}">
				<authentication username="${bsdn.nexus.user}" password="${bsdn.nexus.password}" />
			</remoteRepository>
			<pom file="${target.pom.dir}/dorado-parent.pom" />
		</artifact:deploy>

		<foreach list="${product.modules}" param="module" target="publish-module-to-bsdn" inheritall="true" />
	</target>

	<target name="publish" if="publish-jars">
		<if>
			<equals arg1="${product.qualifier}" arg2="RELEASE" />
			<then>
				<property name="maven.repository" value="${bsdn.nexus-release}" />
			</then>
			<else>
				<property name="maven.repository" value="${bsdn.nexus-snapshots}" />
			</else>
		</if>
		<antcall target="publish-to-bsdn" inheritAll="true" />
	</target>

	<target name="build" depends="package,javadoc,publish" />
</project>
