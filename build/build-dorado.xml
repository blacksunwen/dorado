<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:artifact="antlib:org.apache.maven.artifact.ant"
         name="build"
         default="buildAndPublish">
	<property environment="env" />
	<property file="build.properties" />

	<property name="vendor" value="www.BSTEK.com" />
	<property name="version" value="7.0.11" />
	<property name="qualifier" value="SNAPSHOT" />

	<property name="targetDir" value="${rootWorkDir}/target" />

	<taskdef resource="net/sf/antcontrib/antlib.xml"
	         classpath="lib/ant-contrib-1.0b3.jar" />
	<taskdef resource="com/bstek/dorado/addonbuilder/task.properties"
	         classpath="lib/dorado-addon-builder-1.0.0.jar" />
	<typedef resource="org/apache/maven/artifact/ant/antlib.xml"
	         uri="antlib:org.apache.maven.artifact.ant"
	         classpath="lib/maven-ant-tasks-2.1.3.jar" />

	<target name="buildCore">
		<delete dir="${rootWorkDir}/core" />
		<mkdir dir="${rootWorkDir}/core" />

		<buildDoradoAddon baseDir="${workspaceDir}/core"
		                  workDir="${rootWorkDir}/core"
		                  targetDir="${targetDir}"
		                  name="dorado-core"
		                  vendor="${vendor}"
		                  version="${version}"
		                  qualifier="${qualifier}"
		                  buildSourceJar="${buildSourceJar}"
		                  buildJsDoc="${buildJsDoc}"
		                  buildJavaDoc="${buildJavaDoc}"
		                  clientSrc="${workspaceDir}/client/client"
		                  javaSrc="${workspaceDir}/core/src,${workspaceDir}/data/src,${workspaceDir}/web/src,${workspaceDir}/view/src" />
		<echo message="Build Dorado Addon Succeed: ${baseFileName}" />
		<property name="coreBaseFileName" value="${baseFileName}" />
	</target>

	<target name="buildIdeSupport">
		<delete dir="${rootWorkDir}/ide-support" />
		<mkdir dir="${rootWorkDir}/ide-support" />

		<buildDoradoAddon baseDir="${workspaceDir}/ide-support"
		                  workDir="${rootWorkDir}/ide-support"
		                  targetDir="${targetDir}"
		                  name="dorado-ide-support"
		                  vendor="${vendor}"
		                  version="${version}"
		                  qualifier="${qualifier}"
		                  buildJavaDoc="${buildJavaDoc}" />
		<echo message="Build Dorado Addon Succeed: ${baseFileName}" />
		<property name="ideSupportBaseFileName" value="${baseFileName}" />
	</target>

	<target name="publishCore">
		<var name="archieveName" value="${coreBaseFileName}" />
		<echo message="Publish to bsdn: ${targetDir}/${archieveName}.jar --> ${maven.repository}" />

		<artifact:deploy file="${targetDir}/${archieveName}.jar"
		                 settingsfile="resources/maven-settings.xml">
			<remoteRepository url="${maven.repository}">
				<authentication username="${env.BSDN_NEXUS_USER}"
				                password="${env.BSDN_NEXUS_PASSWORD}" />
			</remoteRepository>
			<pom file="${targetDir}/${archieveName}.pom" />
			<attach file="${targetDir}/${archieveName}-sources.jar"
			        type="jar"
			        classifier="sources" />
			<attach file="${targetDir}/${archieveName}-javadoc.jar"
			        type="jar"
			        classifier="javadoc" />
			<attach file="${targetDir}/${archieveName}-jsdoc.zip"
			        type="zip"
			        classifier="jsdoc" />
		</artifact:deploy>
	</target>

	<target name="publishIdeSupport">
		<var name="archieveName" value="${ideSupportBaseFileName}" />
		<echo message="Publish to bsdn: ${targetDir}/${archieveName}.jar --> ${maven.repository}" />

		<artifact:deploy file="${targetDir}/${archieveName}.jar"
		                 settingsfile="resources/maven-settings.xml">
			<remoteRepository url="${maven.repository}">
				<authentication username="${env.BSDN_NEXUS_USER}"
				                password="${env.BSDN_NEXUS_PASSWORD}" />
			</remoteRepository>
			<pom file="${targetDir}/${archieveName}.pom" />
			<attach file="${targetDir}/${archieveName}-sources.jar"
			        type="jar"
			        classifier="sources" />
		</artifact:deploy>
	</target>

	<target name="publish" if="${publish}">
		<if>
			<equals arg1="${qualifier}" arg2="SNAPSHOT" />
			<then>
				<property name="maven.repository"
				          value="${bsdn.nexusSnapshots}" />
			</then>
			<else>
				<property name="maven.repository"
				          value="${bsdn.nexusReleases}" />
			</else>
		</if>

		<antcall target="publishCore" />
		<antcall target="publishIdeSupport" />
	</target>

	<target name="doBuild" depends="buildCore,buildIdeSupport,publish" />

	<target name="buildJars">
		<property name="buildSourceJar" value="false" />
		<property name="buildJsDoc" value="false" />
		<property name="buildJavaDoc" value="false" />
		<property name="publish" value="false" />
		<antcall target="doBuild" />
	</target>

	<target name="buildLibraries">
		<property name="buildSourceJar" value="true" />
		<property name="buildJsDoc" value="true" />
		<property name="buildJavaDoc" value="true" />
		<property name="publish" value="false" />
		<antcall target="doBuild" />
	</target>

	<target name="buildAndPublish">
		<property name="buildSourceJar" value="true" />
		<property name="buildJsDoc" value="true" />
		<property name="buildJavaDoc" value="true" />
		<property name="publish" value="true" />
		<antcall target="doBuild" />
	</target>
</project>
